<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Avarta - Expense Tracker</title>
  
  <!-- Tailwind CSS CDN for styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Inter font from Google Fonts -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
  
  <!-- React and ReactDOM from CDN -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- Babel for JSX transformation in the browser -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Firebase JS SDK (v8.10.0 is used for better single-file compatibility) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  
  <style>
    /* Use Inter font globally */
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>
<body class="bg-gray-100">
  <div id="root"></div>

  <script type="text/jsx">
    // Firebase initialization code
    const firebaseConfig = {
      apiKey: "AIzaSyBdagBD3G6fBRVWztEfpXR4ZzcCHuVR5Rc",
      authDomain: "daily-expense-tracker-4a115.firebaseapp.com",
      projectId: "daily-expense-tracker-4a115",
      storageBucket: "daily-expense-tracker-4a115.firebasestorage.app",
      messagingSenderId: "862714037551",
      appId: "1:862714037551:web:00d29aeef2fc3c33880dda"
    };

    const appId = firebaseConfig.projectId;

    // React hooks
    const { useState, useEffect } = React;
    
    // Lucide Icons (as inline SVGs to avoid import issues)
    const Plus = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
    );
    const Trash2 = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
    );
    const Copy = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
    );
    const Eye = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>
    );
    const EyeOff = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-10-7-10-7a1.8 1.8 0 0 1 1.77-1.46"></path><path d="M12 9a3 3 0 0 0-3 3"></path><path d="M3.18 3.18A19.98 19.98 0 0 1 12 5c7 0 10 7 10 7a1.8 1.8 0 0 1-1.77 1.46"></path><line x1="2" y1="2" x2="22" y2="22"></line></svg>
    );

    // Main App Component
    function App() {
      const [db, setDb] = useState(null);
      const [auth, setAuth] = useState(null);
      const [userId, setUserId] = useState(null);
      const [expenses, setExpenses] = useState([]);
      const [description, setDescription] = useState('');
      const [amount, setAmount] = useState('');
      const [loading, setLoading] = useState(true);
      const [userSessionId, setUserSessionId] = useState('');
      const [message, setMessage] = useState('');
      const [showSessionId, setShowSessionId] = useState(false);

      useEffect(() => {
        try {
          // Initialize Firebase using the global `firebase` object from v8 SDK
          const app = firebase.initializeApp(firebaseConfig);
          const firestoreDb = app.firestore();
          const authService = app.auth();
          setDb(firestoreDb);
          setAuth(authService);
    
          const unsubscribe = authService.onAuthStateChanged((user) => {
            if (user) {
              setUserId(user.uid);
              setMessage('');
            } else {
              setUserId(null);
            }
            setLoading(false);
          });
    
          const signIn = async () => {
            try {
              await authService.signInAnonymously();
            } catch (error) {
              console.error("Firebase Auth error:", error);
              setMessage(`Authentication failed. Please try again. Error: ${error.message}`);
            }
          };
    
          if (!authService.currentUser) {
            signIn();
          }
    
          return () => unsubscribe();
        } catch (error) {
          console.error("Firebase initialization error:", error);
          setMessage(`Initialization failed. Please check the console for details. Error: ${error.message}`);
          setLoading(false);
        }
      }, []);

      useEffect(() => {
        if (db && userId && userSessionId) {
          const expensesCollectionPath = `artifacts/${appId}/users/${userSessionId}/expenses`;
          
          const unsubscribe = db.collection(expensesCollectionPath).onSnapshot((querySnapshot) => {
            const expensesData = [];
            querySnapshot.forEach((doc) => {
              expensesData.push({ id: doc.id, ...doc.data() });
            });
            expensesData.sort((a, b) => b.timestamp - a.timestamp);
            setExpenses(expensesData);
          }, (error) => {
            console.error("Error fetching expenses:", error);
            setMessage(`Failed to load expenses. Error: ${error.message}`);
          });

          return () => unsubscribe();
        }
      }, [db, userId, userSessionId, appId]);

      const addExpense = async () => {
        if (!description || !amount || !userSessionId) {
          setMessage('Please enter a description, amount, and a valid session ID.');
          return;
        }

        const numericAmount = parseFloat(amount);
        if (isNaN(numericAmount) || numericAmount <= 0) {
          setMessage('Please enter a valid positive number for the amount.');
          return;
        }

        try {
          const expensesCollectionPath = `artifacts/${appId}/users/${userSessionId}/expenses`;
          await db.collection(expensesCollectionPath).add({
            description: description,
            amount: numericAmount,
            timestamp: Date.now(),
          });
          setDescription('');
          setAmount('');
          setMessage('Expense saved!');
        } catch (e) {
          console.error("Error adding document: ", e);
          setMessage(`Error: Could not save expense. ${e.message}`);
        }
      };

      const deleteExpense = async (id) => {
        if (!userSessionId) {
          setMessage('Please enter a valid session ID to delete expenses.');
          return;
        }

        try {
          const expensesCollectionPath = `artifacts/${appId}/users/${userSessionId}/expenses`;
          await db.collection(expensesCollectionPath).doc(id).delete();
          setMessage('Expense deleted.');
        } catch (e) {
          console.error("Error removing document: ", e);
          setMessage(`Error: Could not delete expense. ${e.message}`);
        }
      };

      const generateSessionId = () => {
        const newId = `guest-${crypto.randomUUID()}`;
        setUserSessionId(newId);
        setMessage(`New session ID created. Copy and save it to log in next time.`);
      };

      const copyToClipboard = (text) => {
        const el = document.createElement('textarea');
        el.value = text;
        document.body.appendChild(el);
        el.select();
        try {
          document.execCommand('copy');
          setMessage('Session ID copied to clipboard!');
        } catch (err) {
          console.error('Failed to copy text: ', err);
          setMessage('Failed to copy. Please manually select and copy the text.');
        }
        document.body.removeChild(el);
      };
      
      const MessageBox = ({ message, onClose }) => (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50">
          <div className="w-full max-w-sm p-6 bg-white rounded-lg shadow-2xl">
            <p className="text-gray-800">{message}</p>
            <div className="mt-4 text-right">
              <button
                onClick={onClose}
                className="px-4 py-2 text-sm font-semibold text-white transition-colors bg-blue-500 rounded-md hover:bg-blue-600"
              >
                OK
              </button>
            </div>
          </div>
        </div>
      );

      return (
        <div className="flex items-center justify-center min-h-screen bg-gray-100 font-inter">
          <div className="w-full max-w-lg p-8 m-4 bg-white rounded-xl shadow-2xl transition-all duration-300">
            <div className="flex items-center justify-center mb-6">
              <h1 className="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-500 to-indigo-600">
                Avarta
              </h1>
            </div>

            <div className="mb-6 space-y-4">
              <label className="block text-sm font-medium text-gray-700">
                Session ID:
              </label>
              <div className="relative flex items-center space-x-2">
                <input
                  type={showSessionId ? "text" : "password"}
                  className="flex-1 block w-full p-3 text-sm text-gray-900 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm"
                  placeholder="Enter your session ID or create a new one"
                  value={userSessionId}
                  onChange={(e) => setUserSessionId(e.target.value)}
                />
                <button
                  onClick={() => setShowSessionId(!showSessionId)}
                  className="p-2 transition-colors duration-200 bg-gray-200 rounded-lg hover:bg-gray-300"
                  aria-label={showSessionId ? "Hide session ID" : "Show session ID"}
                >
                  {showSessionId ? <EyeOff /> : <Eye />}
                </button>
                <button
                  onClick={() => copyToClipboard(userSessionId)}
                  disabled={!userSessionId}
                  className="p-2 transition-colors duration-200 bg-gray-200 rounded-lg hover:bg-gray-300 disabled:opacity-50"
                  aria-label="Copy session ID"
                >
                  <Copy />
                </button>
              </div>
              <div className="flex justify-between space-x-2">
                <button
                  onClick={generateSessionId}
                  className="flex-1 px-4 py-2 text-sm font-semibold text-white transition-colors duration-200 bg-green-500 rounded-lg shadow-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2"
                >
                  Create New Session
                </button>
              </div>
            </div>

            <div className="mb-6 p-4 rounded-lg bg-gray-50 shadow-inner">
              <h2 className="mb-4 text-xl font-semibold text-gray-800">Add New Expense</h2>
              <div className="space-y-4">
                <input
                  type="text"
                  placeholder="Description (e.g., Coffee)"
                  className="block w-full p-3 text-sm text-gray-900 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm"
                  value={description}
                  onChange={(e) => setDescription(e.target.value)}
                />
                <input
                  type="number"
                  placeholder="Amount (e.g., 4.50)"
                  className="block w-full p-3 text-sm text-gray-900 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm"
                  value={amount}
                  onChange={(e) => setAmount(e.target.value)}
                />
                <button
                  onClick={addExpense}
                  disabled={!userSessionId}
                  className="flex items-center justify-center w-full px-4 py-3 text-sm font-semibold text-white transition-colors duration-200 bg-blue-600 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50"
                >
                  <span className="mr-2"><Plus /></span>
                  Add Expense
                </button>
              </div>
            </div>

            <h2 className="mb-4 text-xl font-semibold text-gray-800">Recent Expenses</h2>
            {userSessionId && expenses.length > 0 ? (
              <ul className="space-y-3">
                {expenses.map((expense) => (
                  <li
                    key={expense.id}
                    className="flex items-center justify-between p-4 transition-all duration-200 bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md"
                  >
                    <div>
                      <p className="text-sm font-medium text-gray-900">{expense.description}</p>
                      <p className="text-lg font-bold text-gray-700">
                        ${expense.amount.toFixed(2)}
                      </p>
                    </div>
                    <button
                      onClick={() => deleteExpense(expense.id)}
                      className="p-2 transition-colors duration-200 bg-red-100 rounded-full text-red-500 hover:bg-red-200"
                      aria-label="Delete expense"
                    >
                      <Trash2 />
                    </button>
                  </li>
                ))}
              </ul>
            ) : (
              <p className="p-4 text-sm text-center text-gray-500 bg-gray-50 rounded-lg">
                {userSessionId ? "No expenses found. Start adding some!" : "Enter a session ID to view expenses."}
              </p>
            )}
          </div>

          {message && <MessageBox message={message} onClose={() => setMessage('')} />}
        </div>
      );
    }

    const container = document.getElementById('root');
    const root = ReactDOM.createRoot(container);
    root.render(<App />);
  </script>
</body>
</html>
