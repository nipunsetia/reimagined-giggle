<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Āvarta: Finance Flow</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import {
            initializeApp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            signInWithCustomToken,
            signInAnonymously,
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            setDoc,
            onSnapshot,
            collection,
            addDoc,
            deleteDoc,
            updateDoc,
            getDocs,
            query,
            where,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Hardcoded Firebase config to resolve environment error
        const firebaseConfig = {
            apiKey: "AIzaSyBdagBD3G6fBRVWztEfpXR4ZzcCHuVR5Rc",
            authDomain: "daily-expense-tracker-4a115.firebaseapp.com",
            projectId: "daily-expense-tracker-4a115",
            storageBucket: "daily-expense-tracker-4a115.firebasestorage.app",
            messagingSenderId: "862714037551",
            appId: "1:862714037551:web:00d29aeef2fc3c33880dda"
        };
        const appId = firebaseConfig.projectId;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let userId = null;
        let expensesCollectionRef = null;
        let allExpenses = [];
        let username = null;
        let budget = 0;
        let quoteRefreshCount = 0;
        const MAX_QUOTE_REFRESHES = 5;
        let logsCollectionRef = null;
        let userSettingsDocRef = null;
        let currency = 'INR';
        let currencySymbol = '₹';

        // Get DOM elements
        const quoteText = document.getElementById('dynamic-quote');
        const usernameDisplay = document.getElementById('username-display');
        const usernameModal = document.getElementById('username-modal');
        const usernameForm = document.getElementById('username-form');
        const usernameInput = document.getElementById('username-input');
        const suggestUsernameBtn = document.getElementById('suggest-username-btn');
        const changeUserBtn = document.getElementById('change-user-btn');
        const expenseForm = document.getElementById('expense-form');
        const expenseNameInput = document.getElementById('expense-name');
        const expenseAmountInput = document.getElementById('expense-amount');
        const expenseCategorySelect = document.getElementById('expense-category');
        const expenseDateInput = document.getElementById('expense-date');
        const recurringCheckbox = document.getElementById('recurring-checkbox');
        const recurringToggleLabel = document.getElementById('recurring-toggle-label');
        const recurringOptionsContainer = document.getElementById('recurring-options-container');
        const weeklyOptions = document.getElementById('weekly-options');
        const monthlyOptions = document.getElementById('monthly-options');
        const expensesList = document.getElementById('expenses-list');
        const totalExpensesText = document.getElementById('total-expenses');
        const remainingBudgetText = document.getElementById('remaining-budget');
        const budgetProgress = document.getElementById('budget-progress');
        const budgetForm = document.getElementById('budget-form');
        const budgetInput = document.getElementById('budget-input');
        const recurrenceFreqRadios = document.querySelectorAll('input[name="recurrence-freq"]');
        const monthFilterSelect = document.getElementById('month-filter');
        const yearFilterSelect = document.getElementById('year-filter');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const closeMessageBtn = document.getElementById('close-message-btn');
        const chartCanvas = document.getElementById('main-chart-canvas');
        const chartTitle = document.getElementById('chart-title');
        const chartBtns = document.querySelectorAll('.chart-btn');
        const aiBudgetSuggestionBtn = document.getElementById('ai-budget-suggestion-btn');
        const exportJsonBtn = document.getElementById('export-json-btn');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const quoteRefreshBtn = document.getElementById('quote-refresh-btn');
        const refreshCountDisplay = document.getElementById('refresh-count');
        const logsList = document.getElementById('logs-list');
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        const currencySelect = document.getElementById('currency-select');
        const userIdDisplay = document.getElementById('user-id-display');


        let currentChartInstance = null;

        const aiBudgetSuggestions = [
            "Set a daily spending limit and track it actively.",
            "Review your subscriptions and cancel any you don't use.",
            "Create a 'needs' versus 'wants' list for better spending habits.",
            "Try the 50/30/20 rule: 50% for needs, 30% for wants, 20% for savings.",
            "Automate your savings to build wealth effortlessly.",
            "Cook at home more often to save money on dining out.",
            "Use a budgeting app to categorize and understand your spending.",
            "Track your small, daily expenses; they add up quickly!",
            "Plan your meals for the week to avoid impulse grocery purchases.",
            "Compare prices before making a major purchase.",
            "Set specific financial goals, like saving for a vacation or a down payment.",
            "Review your phone and internet plans for potential savings.",
            "Negotiate your bills, such as cable or insurance, for a better rate.",
            "Start an emergency fund with at least 3-6 months of living expenses.",
            "Pay down high-interest debt, like credit card balances, first.",
            "Use cash for discretionary spending to stay within your budget.",
            "Try a no-spend challenge for a week or a month.",
            "Cut back on impulse purchases by waiting 24 hours before buying.",
            "Look for free or low-cost entertainment options.",
            "Buy second-hand items instead of new ones when possible.",
            "Refinance your mortgage or student loans if it makes financial sense.",
            "Invest in low-cost index funds for long-term growth.",
            "Open a high-yield savings account to earn more on your cash.",
            "Review your monthly statements for any fraudulent or forgotten charges.",
            "Learn to differentiate between asset and liability.",
            "Avoid lifestyle creep as your income increases.",
            "Pack your own lunch to save on daily food costs.",
            "Consider a side hustle to increase your income.",
            "Invest in yourself through education or skill-building.",
            "Understand your tax obligations and plan for them.",
            "Diversify your investments to manage risk.",
            "Practice mindful spending by thinking about each purchase.",
            "Create a debt repayment plan with a clear timeline.",
            "Build a financial calendar to stay on top of bills.",
            "Use a credit card with rewards, but pay the balance in full each month.",
            "Talk to a financial advisor for personalized guidance.",
            "Make sure your retirement savings are on track.",
            "Consider canceling unused gym memberships or subscriptions.",
            "Buy in bulk for non-perishable items to save money.",
            "Repair instead of replacing items when possible.",
            "Look for free software alternatives to paid programs.",
            "Use public transportation or carpool to save on fuel.",
            "Find cheaper alternatives for your coffee habit.",
            "Always have a budget, no matter your income level.",
            "Don't let emotions guide your financial decisions.",
            "Invest in a good quality, reusable water bottle and coffee mug.",
            "Plan for annual and semi-annual expenses in your monthly budget.",
            "Make sure you have adequate insurance coverage.",
            "Consider a 'sinking fund' for specific future expenses.",
            "Review your utility bills for ways to save energy.",
            "Take advantage of employer-sponsored retirement plans.",
            "Teach yourself about personal finance through books or podcasts.",
            "Use coupons or discount codes whenever you shop.",
            "Sell items you no longer need to earn extra cash.",
            "Set up a password manager for your financial accounts.",
            "Check your credit report regularly for errors.",
            "Review your banking fees and switch to a fee-free bank if possible.",
            "Keep track of your net worth to monitor your progress.",
            "Don't compare your financial journey to others.",
            "Focus on long-term wealth building, not quick wins.",
            "Build good credit by paying bills on time.",
            "Automate bill payments to avoid late fees.",
            "Set aside money for a 'fun' budget to prevent burnout.",
            "Understand the power of compound interest.",
            "Review your investment fees; they can eat into your returns.",
            "Avoid carrying a balance on credit cards.",
            "Save for big purchases in advance to avoid debt.",
            "Create a budget that is realistic and flexible.",
            "Track your savings rate and try to increase it over time.",
            "Invest in your health to prevent future medical costs.",
            "Avoid taking out personal loans unless absolutely necessary.",
            "Create a meal plan to reduce food waste.",
            "Be aware of financial scams and fraud.",
            "Set aside a small amount each week for a 'play' budget.",
            "Make sure your beneficiaries are up-to-date on all accounts.",
            "Keep a record of your financial goals.",
            "Look for loyalty programs and rewards at places you frequent.",
            "Understand the difference between tax-deductible and non-deductible expenses.",
            "Consider creating a will or living trust.",
            "Try to live below your means.",
            "Review your monthly bank statements carefully.",
            "Start a 'side hustle' to create another income stream.",
            "Use price tracking apps for online shopping.",
            "Always look for ways to cut down on expenses.",
            "Review your insurance policies to ensure they meet your needs.",
            "Set a savings goal for your next big vacation.",
            "Practice saying 'no' to social events that are outside your budget.",
            "Keep an eye on market trends, but don't panic sell.",
            "Educate yourself on different investment vehicles.",
            "Save a portion of every raise or bonus you receive.",
            "Avoid get-rich-quick schemes.",
            "Create a financial binder with all your important documents.",
            "Don't be afraid to ask for a raise at work.",
            "Track your net worth and celebrate your progress.",
            "Set a 'financial check-in' date each month.",
            "Ensure your financial goals are specific, measurable, and achievable.",
            "Consider the environmental impact of your purchases.",
            "Keep your money in a separate account for savings.",
            "Avoid paying for things you can get for free, like banking services.",
            "Make sure you're getting the best interest rate on your loans.",
            "Review your credit card statements for any errors.",
            "Save for your retirement early to take advantage of compounding.",
            "Understand the fees associated with your investments."
        ];


        // Utility Functions
        const showMessage = (title, message, isError = false) => {
            messageBox.classList.remove('hidden');
            document.getElementById('message-title').textContent = title;
            messageText.textContent = message;
            if (isError) {
                messageBox.classList.remove('bg-slate-800');
                messageBox.classList.add('bg-red-800');
            } else {
                messageBox.classList.remove('bg-red-800');
                messageBox.classList.add('bg-slate-800');
            }
        };

        const hideMessage = () => {
            messageBox.classList.add('hidden');
        };

        const showModal = (modalElement) => {
            modalElement.classList.remove('hidden');
        };

        const hideModal = (modalElement) => {
            modalElement.classList.add('hidden');
        };

        const createOrUpdateChart = (type, labels, data, options, title) => {
            if (currentChartInstance) {
                currentChartInstance.destroy();
            }
            if (chartCanvas) {
                const ctx = chartCanvas.getContext('2d');
                currentChartInstance = new Chart(ctx, {
                    type,
                    data: {
                        labels,
                        datasets: [{
                            data
                        }]
                    },
                    options
                });
                chartTitle.textContent = title;
            }
        };

        const renderChart = (chartType, expenses) => {
            const filteredExpenses = expenses.filter(expense => {
                const date = new Date(expense.timestamp);
                const expenseMonth = date.getMonth().toString();
                const expenseYear = date.getFullYear().toString();
                const selectedMonth = monthFilterSelect.value;
                const selectedYear = yearFilterSelect.value;
                return (selectedMonth === 'all' || expenseMonth === selectedMonth) &&
                    (selectedYear === 'all' || expenseYear === selectedYear);
            });

            if (chartType === 'category') {
                const categoryMap = filteredExpenses.reduce((acc, expense) => {
                    const {
                        category,
                        amount
                    } = expense;
                    acc[category] = (acc[category] || 0) + amount;
                    return acc;
                }, {});
                const categories = Object.keys(categoryMap);
                const amounts = Object.values(categoryMap);
                createOrUpdateChart('pie', categories, amounts, {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#e2e8f0'
                            }
                        },
                        title: {
                            display: false
                        }
                    }
                }, 'Category Breakdown');
            } else if (chartType === 'monthly') {
                const monthlyMap = filteredExpenses.reduce((acc, expense) => {
                    const date = new Date(expense.timestamp);
                    const month = date.toLocaleString('default', {
                        month: 'short'
                    }) + ' ' + date.getFullYear();
                    acc[month] = (acc[month] || 0) + expense.amount;
                    return acc;
                }, {});
                const months = Object.keys(monthlyMap);
                const monthlyAmounts = Object.values(monthlyMap);
                createOrUpdateChart('bar', months, monthlyAmounts, {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            },
                            ticks: {
                                color: '#e2e8f0'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            },
                            ticks: {
                                color: '#e2e8f0'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: false
                        }
                    }
                }, 'Monthly Trends');
            } else if (chartType === 'daily') {
                const dailyMap = filteredExpenses.reduce((acc, expense) => {
                    const date = new Date(expense.timestamp).toLocaleDateString();
                    acc[date] = (acc[date] || 0) + expense.amount;
                    return acc;
                }, {});
                const dates = Object.keys(dailyMap).sort((a, b) => new Date(a) - new Date(b));
                const dailyAmounts = dates.map(date => dailyMap[date]);
                createOrUpdateChart('line', dates, dailyAmounts, {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            },
                            ticks: {
                                color: '#e2e8f0'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            },
                            ticks: {
                                color: '#e2e8f0'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: false
                        }
                    }
                }, 'Daily Flow');
            }
        };

        const showTab = (tabId) => {
            tabContents.forEach(content => content.classList.add('hidden'));
            tabBtns.forEach(btn => btn.classList.remove('bg-amber-500', 'text-slate-900', 'hover:bg-amber-400'));
            tabBtns.forEach(btn => btn.classList.add('bg-slate-700', 'text-slate-300', 'hover:bg-slate-600'));
            document.getElementById(tabId).classList.remove('hidden');
            const clickedBtn = document.querySelector(`[data-tab-id="${tabId}"]`);
            clickedBtn.classList.remove('bg-slate-700', 'text-slate-300', 'hover:bg-slate-600');
            clickedBtn.classList.add('bg-amber-500', 'text-slate-900', 'hover:bg-amber-400');
        };

        // Firebase-related Functions
        const checkUsername = async () => {
            if (!userId) return;
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/user_data`);
            try {
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists()) {
                    username = userDoc.data().username;
                    usernameDisplay.textContent = username;
                    hideModal(usernameModal);
                } else {
                    showModal(usernameModal);
                }
            } catch (error) {
                console.error("Error fetching user profile: ", error);
                showModal(usernameModal);
            }
        };

        const saveUsername = async (newUsername) => {
            if (!userId || !newUsername) return;
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/user_data`);
            try {
                await setDoc(userDocRef, {
                    username: newUsername,
                    lastUpdated: Date.now()
                });
                username = newUsername;
                usernameDisplay.textContent = username;
                hideModal(usernameModal);
                showMessage("Success", `Username "${newUsername}" saved successfully!`);
                addLog(`Username changed to "${newUsername}"`);
            } catch (error) {
                console.error("Error saving username: ", error);
                showMessage("Error", "Failed to save username. Please try again.", true);
            }
        };
        
        const saveCurrency = async (newCurrency) => {
            if (!userId) return;
            try {
                await setDoc(userSettingsDocRef, { currency: newCurrency }, { merge: true });
                showMessage("Success", `Currency set to ${newCurrency}.`);
                addLog(`Currency changed to ${newCurrency}`);
            } catch (error) {
                console.error("Error saving currency: ", error);
                showMessage("Error", "Failed to save currency. Please try again.", true);
            }
        };

        const saveBudget = async (e) => {
            e.preventDefault();
            const newBudget = parseFloat(budgetInput.value);
            if (!userId || newBudget <= 0) {
                showMessage("Validation Error", "Please enter a valid budget amount.", true);
                return;
            }
            const budgetDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/budget`);
            try {
                await setDoc(budgetDocRef, {
                    amount: newBudget,
                    lastUpdated: Date.now()
                });
                budget = newBudget; // Update local budget variable
                showMessage("Success", `Budget set to ${currencySymbol}${newBudget.toFixed(2)}.`);
                addLog(`Budget set to ${currencySymbol}${newBudget.toFixed(2)}`);
            } catch (error) {
                console.error("Error saving budget: ", error);
                showMessage("Error", "Failed to save budget. Please try again.", true);
            }
        };

        const renderBudgetUI = (totalExpenses) => {
            const remaining = budget - totalExpenses;
            totalExpensesText.textContent = `${currencySymbol}${totalExpenses.toFixed(2)}`;
            remainingBudgetText.textContent = `${currencySymbol}${remaining.toFixed(2)}`;

            remainingBudgetText.classList.remove('text-green-500', 'text-red-500');
            remainingBudgetText.classList.add(remaining >= 0 ? 'text-green-500' : 'text-red-500');

            if (budget > 0) {
                const percentage = Math.min((totalExpenses / budget) * 100, 100);
                budgetProgress.style.width = `${percentage}%`;

                budgetProgress.classList.remove('bg-amber-500', 'bg-red-500');
                if (percentage >= 100) {
                    budgetProgress.classList.add('bg-red-500');
                } else {
                    budgetProgress.classList.add('bg-amber-500');
                }
            } else {
                budgetProgress.style.width = '0%';
            }
        };

        const changeUser = async () => {
            try {
                // Delete user data.
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/user_data`);
                await deleteDoc(userDocRef);
                const budgetDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/budget`);
                await deleteDoc(budgetDocRef);

                // Clear expenses collection.
                const expensesQuery = query(collection(db, `artifacts/${appId}/users/${userId}/expenses`));
                const querySnapshot = await getDocs(expensesQuery);
                const batch = writeBatch(db);
                querySnapshot.forEach((doc) => {
                    batch.delete(doc.ref);
                });
                await batch.commit();

                // Sign out and let onAuthStateChanged handle the new anonymous user
                await signOut(auth);
                showMessage("Success", "User profile cleared. Please create a new username.");
            } catch (error) {
                console.error("Error changing user:", error);
                showMessage("Error", "Could not change user. Please try again.", true);
            }
        };
        
        const addLog = async (action) => {
            if (!userId) return;
            const logData = {
                action,
                timestamp: Date.now()
            };
            try {
                if (logsCollectionRef) {
                     await addDoc(logsCollectionRef, logData);
                }
            } catch (error) {
                console.error("Error adding log:", error);
            }
        };

        const renderLogs = (logs) => {
            logsList.innerHTML = '';
            if (logs.length === 0) {
                logsList.innerHTML = `<li class="text-center text-slate-400">No logs found.</li>`;
            } else {
                logs.sort((a, b) => b.timestamp - a.timestamp);
                logs.forEach(log => {
                    const li = document.createElement('li');
                    li.className = 'bg-slate-700 p-3 rounded-lg shadow-md mb-2';
                    const timestamp = new Date(log.timestamp).toLocaleString();
                    li.innerHTML = `
                        <p class="text-slate-300">${log.action}</p>
                        <p class="text-xs text-slate-500 mt-1">${timestamp}</p>
                    `;
                    logsList.appendChild(li);
                });
            }
        };

        // API Call for Quotes
        const getDynamicQuote = async () => {
            const staticQuotes = [{
                text: "The only way to get a good idea is to get a lot of ideas.",
                source: "Linus Pauling"
            }, {
                text: "Don't tell me where your priorities are. Show me where you spend your money and I'll tell you what they are.",
                source: "James W. Frick"
            }, {
                text: "The stock market is a device for transferring money from the impatient to the patient.",
                source: "Warren Buffett"
            }, {
                text: "Do not save what is left after spending; instead, spend what is left after saving.",
                source: "Warren Buffett"
            }, {
                text: "The journey of a thousand miles begins with a single step.",
                source: "Lao Tzu"
            }];
            const quotePrompt = "Give a short, inspiring quote on a topic from: movies, music, culture, poetry, art, science, stoicism, finance, facts, or puns. Provide a brief one-sentence quote.";
            
            if (quoteRefreshCount < MAX_QUOTE_REFRESHES) {
                try {
                    const chatHistory = [{
                        role: "user",
                        parts: [{
                            text: quotePrompt
                        }]
                    }];
                    const payload = {
                        contents: chatHistory
                    };
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                    let response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    let result = await response.json();

                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts) {
                        const text = result.candidates[0].content.parts[0].text;
                        quoteText.textContent = text.replace(/["“”„‟‘’‚‛‹›«»「」『』【】《》〈〉《》「」『』】]/g, '');
                        quoteRefreshCount++;
                        refreshCountDisplay.textContent = `Refreshes left: ${MAX_QUOTE_REFRESHES - quoteRefreshCount}`;
                        addLog("Quote refreshed.");
                    } else {
                        const randomQuote = staticQuotes[Math.floor(Math.random() * staticQuotes.length)];
                        quoteText.textContent = `"${randomQuote.text}" - ${randomQuote.source}`;
                    }
                } catch (error) {
                    console.error("Error fetching quote:", error);
                    const randomQuote = staticQuotes[Math.floor(Math.random() * staticQuotes.length)];
                    quoteText.textContent = `"${randomQuote.text}" - ${randomQuote.source}`;
                }
            } else {
                showMessage("Limit Reached", "You have reached the maximum number of quote refreshes for this session.", true);
            }
        };

        // API Call for Username Suggestion
        const suggestUsername = async () => {
            try {
                const prompt = "Suggest a memorable and sensible username that is 8-12 alphanumeric characters long. Do not include spaces or special characters. Make it financial-themed. Only provide the username, no other text.";
                const chatHistory = [{
                    role: "user",
                    parts: [{
                        text: prompt
                    }]
                }];
                const payload = {
                    contents: chatHistory
                };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                let response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                let result = await response.json();

                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts) {
                    const suggestedName = result.candidates[0].content.parts[0].text.trim();
                    usernameInput.value = suggestedName;
                } else {
                    usernameInput.value = `User_${Math.floor(Math.random() * 9999)}`;
                }
            } catch (error) {
                console.error("Error suggesting username:", error);
                usernameInput.value = `User_${Math.floor(Math.random() * 9999)}`;
            }
        };

        const getAiBudgetSuggestion = () => {
            const randomIndex = Math.floor(Math.random() * aiBudgetSuggestions.length);
            const suggestionText = aiBudgetSuggestions[randomIndex];
            
            const suggestionContainer = document.getElementById('budget-suggestions-container');
            suggestionContainer.innerHTML = ''; // Clear previous suggestions
            
            const aiMessageDiv = document.createElement('div');
            aiMessageDiv.className = 'text-left my-2';
            aiMessageDiv.innerHTML = `<span class="inline-block bg-slate-700 text-slate-200 rounded-lg p-3 max-w-sm">${suggestionText}</span>`;
            suggestionContainer.appendChild(aiMessageDiv);
            
            addLog("Received AI budget suggestion.");
        };

        const addExpense = async (e) => {
            e.preventDefault();
            const name = expenseNameInput.value.trim();
            const amount = parseFloat(expenseAmountInput.value);
            const category = expenseCategorySelect.value;
            const date = expenseDateInput.value;
            const isRecurring = recurringCheckbox.checked;

            if (!name || amount <= 0 || !date) {
                showMessage("Validation Error", "Please enter a valid expense name, amount, and date.", true);
                return;
            }

            const expenseData = {
                name,
                amount,
                category,
                timestamp: new Date(date).getTime(),
                isRecurring
            };

            if (isRecurring) {
                const frequency = document.querySelector('input[name="recurrence-freq"]:checked')?.value;
                if (!frequency) {
                    showMessage("Validation Error", "Please select a recurrence frequency.", true);
                    return;
                }
                expenseData.recurrenceFrequency = frequency;

                if (frequency === 'weekly') {
                    const selectedDays = Array.from(document.querySelectorAll('input[name="weekly-day"]:checked')).map(cb => cb.value);
                    if (selectedDays.length === 0) {
                        showMessage("Validation Error", "Please select at least one day for weekly recurrence.", true);
                        return;
                    }
                    expenseData.recurrenceDetails = {
                        days: selectedDays
                    };
                } else if (frequency === 'monthly') {
                    const selectedDate = document.getElementById('monthly-date').value;
                    if (!selectedDate || selectedDate < 1 || selectedDate > 31) {
                        showMessage("Validation Error", "Please select a valid day of the month for monthly recurrence.", true);
                        return;
                    }
                    expenseData.recurrenceDetails = {
                        date: selectedDate
                    };
                }
            }

            try {
                if (expensesCollectionRef) {
                    await addDoc(expensesCollectionRef, expenseData);
                    showMessage("Success", "Expense added successfully!");
                    addLog(`Added new expense: ${name} (${currencySymbol}${amount.toFixed(2)})`);
                    expenseForm.reset();
                    checkFormValidity();
                }
            } catch (error) {
                console.error("Error adding expense: ", error);
                showMessage("Error", "Failed to add expense. Please try again.", true);
            }
        };

        const deleteExpense = async (docId) => {
            try {
                if (userId) {
                    const docRef = doc(db, `artifacts/${appId}/users/${userId}/expenses`, docId);
                    await deleteDoc(docRef);
                    showMessage("Success", "Expense deleted successfully!");
                    addLog(`Deleted expense with ID: ${docId}`);
                }
            } catch (error) {
                console.error("Error deleting expense: ", error);
                showMessage("Error", "Failed to delete expense.", true);
            }
        };
        window.deleteExpense = deleteExpense; // Expose to global scope for onclick

        const renderExpensesList = (expenses, total) => {
            expensesList.innerHTML = '';
            const selectedMonth = monthFilterSelect.value;
            const selectedYear = yearFilterSelect.value;

            const filteredExpenses = expenses.filter(expense => {
                const date = new Date(expense.timestamp);
                const expenseMonth = date.getMonth().toString();
                const expenseYear = date.getFullYear().toString();
                return (selectedMonth === 'all' || expenseMonth === selectedMonth) &&
                    (selectedYear === 'all' || expenseYear === selectedYear);
            });

            if (filteredExpenses.length === 0) {
                expensesList.innerHTML = `<li class="text-center text-slate-400">No expenses found.</li>`;
            } else {
                filteredExpenses.forEach(expense => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-slate-700 p-4 rounded-lg shadow-md mb-2 transition-colors duration-200 hover:bg-slate-600';
                    li.innerHTML = `
                        <div>
                            <p class="font-medium">${expense.name} <span class="text-xs text-slate-400">(${expense.category})</span></p>
                            <p class="text-sm text-slate-400">${currencySymbol}${expense.amount.toFixed(2)}</p>
                        </div>
                        <div class="flex items-center">
                            <span class="text-xs text-slate-400 mr-4">
                                ${new Date(expense.timestamp).toLocaleDateString()}
                            </span>
                            <button class="text-red-400 hover:text-red-500 transition-colors duration-200" onclick="deleteExpense('${expense.id}')">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                            </button>
                        </div>
                    `;
                    expensesList.appendChild(li);
                });
            }
            renderBudgetUI(total);
        };

        const populateFilters = (expenses) => {
            const years = [...new Set(expenses.map(exp => new Date(exp.timestamp).getFullYear()))].sort((a, b) => b - a);
            yearFilterSelect.innerHTML = '<option value="all">All Years</option>';
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearFilterSelect.appendChild(option);
            });

            const today = new Date();
            yearFilterSelect.value = today.getFullYear();
            monthFilterSelect.value = today.getMonth();
        };

        const checkFormValidity = () => {
            const nameIsValid = expenseNameInput.value.trim() !== '';
            const amountIsValid = parseFloat(expenseAmountInput.value) > 0;
            if (nameIsValid && amountIsValid) {
                recurringCheckbox.disabled = false;
            } else {
                recurringCheckbox.disabled = true;
                recurringCheckbox.checked = false;
                recurringOptionsContainer.classList.add('hidden');
            }
        };
        
        const exportData = (format) => {
            const selectedMonth = monthFilterSelect.value;
            const selectedYear = yearFilterSelect.value;
            
            const filteredExpenses = allExpenses.filter(expense => {
                const date = new Date(expense.timestamp);
                const expenseMonth = date.getMonth().toString();
                const expenseYear = date.getFullYear().toString();
                return (selectedMonth === 'all' || expenseMonth === selectedMonth) &&
                       (selectedYear === 'all' || expenseYear === selectedYear);
            });

            let dataStr;
            let fileType;
            let fileName;

            if (format === 'json') {
                dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(filteredExpenses, null, 2));
                fileType = 'application/json';
                fileName = `expenses_${selectedYear}_${selectedMonth}.json`;
            } else if (format === 'csv') {
                const headers = ["ID", "Name", "Amount", "Category", "Date", "IsRecurring"];
                const rows = filteredExpenses.map(exp => [
                    `"${exp.id}"`,
                    `"${exp.name}"`,
                    exp.amount,
                    `"${exp.category}"`,
                    `"${new Date(exp.timestamp).toLocaleDateString()}"`,
                    exp.isRecurring ? "Yes" : "No"
                ].join(','));
                dataStr = "data:text/csv;charset=utf-8," + headers.join(',') + '\n' + rows.join('\n');
                fileType = 'text/csv';
                fileName = `expenses_${selectedYear}_${selectedMonth}.csv`;
            }

            const a = document.createElement('a');
            a.setAttribute("href", dataStr);
            a.setAttribute("download", fileName);
            document.body.appendChild(a);
            a.click();
            a.remove();
            addLog(`Exported expenses to ${format.toUpperCase()} format.`);
        };
        
        const updateCurrencySymbol = (newCurrency) => {
            currency = newCurrency;
            switch(newCurrency) {
                case 'INR': currencySymbol = '₹'; break;
                case 'USD': currencySymbol = '$'; break;
                case 'EUR': currencySymbol = '€'; break;
            }
            // Re-render UI with new currency symbol
            const total = allExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            renderExpensesList(allExpenses, total);
        };


        // Event Listeners
        window.addEventListener('DOMContentLoaded', () => {
            // Initial quote load
            getDynamicQuote();
            refreshCountDisplay.textContent = `Refreshes left: ${MAX_QUOTE_REFRESHES}`;
            // Set up main tabs
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    showTab(btn.getAttribute('data-tab-id'));
                });
            });
            // Show the first tab by default
            showTab('finance-tab');
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                userIdDisplay.textContent = userId;
                expensesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/expenses`);
                logsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/logs`);
                userSettingsDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/settings`);
                checkUsername();

                // Listen for user settings changes (including currency)
                onSnapshot(userSettingsDocRef, (docSnapshot) => {
                    if (docSnapshot.exists()) {
                        const settings = docSnapshot.data();
                        if (settings.currency) {
                            updateCurrencySymbol(settings.currency);
                            currencySelect.value = settings.currency;
                        }
                    }
                });

                // Listen for budget changes
                const budgetDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/budget`);
                onSnapshot(budgetDocRef, (docSnapshot) => {
                    if (docSnapshot.exists()) {
                        budget = docSnapshot.data().amount;
                    } else {
                        budget = 0;
                    }
                    const total = allExpenses.reduce((sum, exp) => sum + exp.amount, 0);
                    renderBudgetUI(total);
                });

                // Listen for logs changes
                 onSnapshot(logsCollectionRef, (snapshot) => {
                     const logs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                     renderLogs(logs);
                 });
                 
                // Listen for expense changes
                onSnapshot(expensesCollectionRef, (snapshot) => {
                    allExpenses = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    const total = allExpenses.reduce((sum, exp) => sum + exp.amount, 0);
                    renderExpensesList(allExpenses, total);
                    populateFilters(allExpenses);
                    renderChart(document.querySelector('.chart-btn.bg-amber-500')?.dataset.chartType || 'category', allExpenses);
                });

            } else {
                // User is signed out, sign in anonymously
                await signInAnonymously(auth);
            }
        });

        usernameForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const newUsername = usernameInput.value.trim();
            if (newUsername) {
                saveUsername(newUsername);
            } else {
                showMessage("Validation Error", "Username cannot be empty.", true);
            }
        });
        suggestUsernameBtn.addEventListener('click', suggestUsername);
        changeUserBtn.addEventListener('click', changeUser);

        closeMessageBtn.addEventListener('click', hideMessage);

        aiBudgetSuggestionBtn.addEventListener('click', getAiBudgetSuggestion);
        quoteRefreshBtn.addEventListener('click', getDynamicQuote);

        expenseForm.addEventListener('submit', addExpense);

        budgetForm.addEventListener('submit', saveBudget);

        recurringCheckbox.addEventListener('change', () => {
            recurringOptionsContainer.classList.toggle('hidden', !recurringCheckbox.checked);
        });

        recurrenceFreqRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                weeklyOptions.classList.toggle('hidden', radio.value !== 'weekly');
                monthlyOptions.classList.toggle('hidden', radio.value !== 'monthly');
            });
        });

        expenseNameInput.addEventListener('input', checkFormValidity);
        expenseAmountInput.addEventListener('input', checkFormValidity);

        monthFilterSelect.addEventListener('change', () => {
            const total = allExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            renderExpensesList(allExpenses, total);
            renderChart(document.querySelector('.chart-btn.bg-amber-500')?.dataset.chartType || 'category', allExpenses);
        });

        yearFilterSelect.addEventListener('change', () => {
            const total = allExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            renderExpensesList(allExpenses, total);
            renderChart(document.querySelector('.chart-btn.bg-amber-500')?.dataset.chartType || 'category', allExpenses);
        });

        chartBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                chartBtns.forEach(b => {
                    b.classList.remove('bg-amber-500', 'text-slate-900', 'hover:bg-amber-400');
                    b.classList.add('bg-slate-700', 'text-slate-300', 'hover:bg-slate-600');
                });
                btn.classList.remove('bg-slate-700', 'text-slate-300', 'hover:bg-slate-600');
                btn.classList.add('bg-amber-500', 'text-slate-900', 'hover:bg-amber-400');
                renderChart(btn.dataset.chartType, allExpenses);
            });
        });
        
        exportJsonBtn.addEventListener('click', () => exportData('json'));
        exportCsvBtn.addEventListener('click', () => exportData('csv'));
        
        currencySelect.addEventListener('change', (e) => {
            saveCurrency(e.target.value);
        });
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>

<body class="bg-slate-900 text-slate-200 antialiased">
    <!-- Message Box -->
    <div id="message-box" class="fixed top-4 right-4 z-50 p-4 rounded-lg shadow-xl text-white max-w-sm hidden transition-all duration-300 ease-in-out bg-slate-800 border border-slate-700">
        <div class="flex justify-between items-center">
            <h4 id="message-title" class="font-bold text-lg"></h4>
            <button id="close-message-btn" class="text-slate-400 hover:text-white transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <p id="message-text" class="mt-2"></p>
    </div>

    <!-- Username Modal -->
    <div id="username-modal" class="fixed inset-0 bg-slate-950 bg-opacity-80 backdrop-blur-sm flex items-center justify-center z-40 hidden">
        <div class="bg-slate-800 p-8 rounded-xl shadow-2xl border border-slate-700 w-full max-w-md mx-4">
            <h2 class="text-2xl font-bold text-amber-500 mb-4">Welcome to Āvarta!</h2>
            <p class="text-slate-400 mb-6">Let's get started. Please enter a username to save your expenses.</p>
            <form id="username-form">
                <input id="username-input" type="text" placeholder="Enter a username..." class="w-full bg-slate-900 text-slate-200 border border-slate-700 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-amber-500 mb-4" required>
                <div class="flex gap-2">
                    <button type="submit" class="flex-grow px-4 py-3 bg-amber-500 text-slate-900 font-bold rounded-lg shadow-md transition-colors duration-200 hover:bg-amber-400">Save Username</button>
                    <button type="button" id="suggest-username-btn" class="flex-grow px-4 py-3 bg-slate-700 text-slate-300 font-bold rounded-lg shadow-md transition-colors duration-200 hover:bg-slate-600">Suggest Username</button>
                </div>
            </form>
        </div>
    </div>


    <header class="bg-slate-800 text-white shadow-lg py-4 px-6 md:px-12 flex flex-col md:flex-row justify-between items-center sticky top-0 z-30 border-b border-slate-700">
        <div class="flex items-center mb-4 md:mb-0">
            <svg class="w-8 h-8 text-amber-500 mr-3" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>
            <h1 class="text-3xl font-extrabold text-amber-500">Āvarta</h1>
            <span class="text-sm font-medium text-slate-400 ml-2">Finance Flow</span>
        </div>
        <div class="flex items-center space-x-4">
            <span id="username-display" class="text-slate-300 font-medium">Loading...</span>
            <select id="currency-select" class="bg-slate-700 text-slate-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-amber-500">
                <option value="INR">INR (₹)</option>
                <option value="USD">USD ($)</option>
                <option value="EUR">EURO (€)</option>
            </select>
            <button id="change-user-btn" class="px-3 py-1 bg-slate-700 text-slate-300 rounded-lg text-sm font-medium hover:bg-slate-600 transition-colors duration-200">Change User</button>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-8">
        <div class="flex overflow-x-auto space-x-2 md:space-x-4 mb-8">
            <button class="tab-btn px-4 py-2 rounded-lg font-medium shadow-md transition-colors duration-200" data-tab-id="finance-tab">Finance</button>
            <button class="tab-btn px-4 py-2 rounded-lg font-medium shadow-md transition-colors duration-200" data-tab-id="analytics-tab">Analytics</button>
        </div>

        <!-- Finance Tab -->
        <div id="finance-tab" class="tab-content w-full max-w-4xl mx-auto hidden">
            <h2 class="text-3xl font-bold text-amber-500 mb-6">Manage Finances</h2>
            <div class="grid md:grid-cols-2 gap-8">
                <!-- Add Expense Section -->
                <div class="bg-slate-800 p-6 rounded-lg shadow-xl border border-slate-700">
                    <h3 class="text-xl font-bold text-slate-300 mb-4">Add New Expense</h3>
                    <form id="expense-form" class="space-y-4">
                        <div>
                            <label for="expense-name" class="block text-sm font-medium text-slate-400">Expense Name</label>
                            <input type="text" id="expense-name" placeholder="E.g., Groceries" class="w-full bg-slate-900 text-slate-200 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-amber-500 mt-1" required>
                        </div>
                        <div>
                            <label for="expense-amount" class="block text-sm font-medium text-slate-400">Amount</label>
                            <input type="number" id="expense-amount" placeholder="1500" class="w-full bg-slate-900 text-slate-200 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-amber-500 mt-1" required min="0">
                        </div>
                        <div>
                            <label for="expense-category" class="block text-sm font-medium text-slate-400">Category</label>
                            <select id="expense-category" class="w-full bg-slate-900 text-slate-200 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-amber-500 mt-1">
                                <option value="Food">Food</option>
                                <option value="Transport">Transport</option>
                                <option value="Shopping">Shopping</option>
                                <option value="Bills">Bills</option>
                                <option value="Entertainment">Entertainment</option>
                                <option value="Health">Health</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label for="expense-date" class="block text-sm font-medium text-slate-400">Date</label>
                            <input type="date" id="expense-date" class="w-full bg-slate-900 text-slate-200 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-amber-500 mt-1" required>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="recurring-checkbox" class="h-4 w-4 text-amber-500 rounded focus:ring-amber-500 border-slate-700 bg-slate-900">
                            <label for="recurring-checkbox" id="recurring-toggle-label" class="text-sm font-medium text-slate-400">Recurring Expense</label>
                        </div>
                        <div id="recurring-options-container" class="space-y-4 hidden transition-all duration-300 ease-in-out">
                            <div class="flex items-center space-x-4">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="recurrence-freq" value="weekly" class="form-radio text-amber-500 focus:ring-amber-500">
                                    <span class="ml-2 text-slate-300">Weekly</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="recurrence-freq" value="monthly" class="form-radio text-amber-500 focus:ring-amber-500">
                                    <span class="ml-2 text-slate-300">Monthly</span>
                                </label>
                            </div>
                            <div id="weekly-options" class="flex flex-wrap gap-2 hidden">
                                <label class="inline-flex items-center"><input type="checkbox" name="weekly-day" value="mon" class="form-checkbox text-amber-500 rounded"> <span class="ml-2 text-slate-300">Mon</span></label>
                                <label class="inline-flex items-center"><input type="checkbox" name="weekly-day" value="tue" class="form-checkbox text-amber-500 rounded"> <span class="ml-2 text-slate-300">Tue</span></label>
                                <label class="inline-flex items-center"><input type="checkbox" name="weekly-day" value="wed" class="form-checkbox text-amber-500 rounded"> <span class="ml-2 text-slate-300">Wed</span></label>
                                <label class="inline-flex items-center"><input type="checkbox" name="weekly-day" value="thu" class="form-checkbox text-amber-500 rounded"> <span class="ml-2 text-slate-300">Thu</span></label>
                                <label class="inline-flex items-center"><input type="checkbox" name="weekly-day" value="fri" class="form-checkbox text-amber-500 rounded"> <span class="ml-2 text-slate-300">Fri</span></label>
                                <label class="inline-flex items-center"><input type="checkbox" name="weekly-day" value="sat" class="form-checkbox text-amber-500 rounded"> <span class="ml-2 text-slate-300">Sat</span></label>
                                <label class="inline-flex items-center"><input type="checkbox" name="weekly-day" value="sun" class="form-checkbox text-amber-500 rounded"> <span class="ml-2 text-slate-300">Sun</span></label>
                            </div>
                            <div id="monthly-options" class="hidden">
                                <label for="monthly-date" class="block text-sm font-medium text-slate-400">Day of the month</label>
                                <input type="number" id="monthly-date" min="1" max="31" class="w-full bg-slate-900 text-slate-200 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-amber-500 mt-1">
                            </div>
                        </div>
                        <button type="submit" class="w-full px-4 py-3 bg-amber-500 text-slate-900 font-bold rounded-lg shadow-md transition-colors duration-200 hover:bg-amber-400">Add Expense</button>
                    </form>
                </div>
                
                <!-- Budgeting Section -->
                <div class="bg-slate-800 p-6 rounded-lg shadow-xl border border-slate-700">
                    <h3 class="text-xl font-bold text-slate-300 mb-4">Budgeting</h3>
                    <form id="budget-form" class="flex gap-4 items-end mb-4">
                        <div class="flex-grow">
                            <label for="budget-input" class="block text-sm font-medium text-slate-400">Monthly Budget</label>
                            <input type="number" id="budget-input" placeholder="50000" class="w-full bg-slate-900 text-slate-200 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-amber-500 mt-1" min="0">
                        </div>
                        <button type="submit" class="px-4 py-3 bg-amber-500 text-slate-900 font-bold rounded-lg shadow-md transition-colors duration-200 hover:bg-amber-400">Set Budget</button>
                    </form>
                    <div class="bg-slate-700 p-4 rounded-lg mb-4">
                        <div class="flex justify-between items-center">
                            <p class="text-slate-400 font-medium">Total Expenses:</p>
                            <p id="total-expenses" class="text-xl font-bold">₹0.00</p>
                        </div>
                        <div class="flex justify-between items-center">
                            <p class="text-slate-400 font-medium">Remaining Budget:</p>
                            <p id="remaining-budget" class="text-xl font-bold">₹0.00</p>
                        </div>
                        <div class="w-full bg-slate-600 rounded-full h-3.5 mt-2">
                            <div id="budget-progress" class="bg-amber-500 h-3.5 rounded-full transition-all duration-500 ease-in-out" style="width: 0%;"></div>
                        </div>
                    </div>
                    <div class="flex justify-end">
                        <button type="button" id="ai-budget-suggestion-btn" class="px-4 py-2 bg-slate-700 text-slate-300 font-bold rounded-lg shadow-md transition-colors duration-200 hover:bg-slate-600">AI Suggestion</button>
                    </div>
                    <div id="budget-suggestions-container" class="mt-4">
                        <!-- AI suggestions will appear here -->
                    </div>
                </div>

                <!-- Quotes & Expenses List section -->
                <div class="md:col-span-2">
                    <div class="grid md:grid-cols-2 gap-8">
                        <div class="bg-slate-800 p-6 rounded-lg shadow-xl border border-slate-700">
                            <h3 class="text-xl font-bold text-slate-300 mb-4">Daily Wisdom</h3>
                            <div class="flex justify-between items-start mb-4">
                                <p id="dynamic-quote" class="text-xl font-semibold text-slate-300 italic max-w-full">
                                    "The only way to get a good idea is to get a lot of ideas." - Linus Pauling
                                </p>
                                <div class="flex flex-col items-center">
                                    <button id="quote-refresh-btn" class="text-amber-500 hover:text-amber-400 transition-colors duration-200 text-3xl">
                                        &#x21bb;
                                    </button>
                                    <span id="refresh-count" class="text-xs text-slate-400 mt-1"></span>
                                </div>
                            </div>
                        </div>
                        <div class="bg-slate-800 p-6 rounded-lg shadow-xl border border-slate-700">
                            <h3 class="text-xl font-bold text-slate-300 mb-4">Expenses List</h3>
                            <div class="flex justify-between items-center mb-4">
                                <div class="flex space-x-2">
                                    <select id="month-filter" class="bg-slate-700 text-slate-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                        <option value="all">All Months</option>
                                        <option value="0">January</option>
                                        <option value="1">February</option>
                                        <option value="2">March</option>
                                        <option value="3">April</option>
                                        <option value="4">May</option>
                                        <option value="5">June</option>
                                        <option value="6">July</option>
                                        <option value="7">August</option>
                                        <option value="8">September</option>
                                        <option value="9">October</option>
                                        <option value="10">November</option>
                                        <option value="11">December</option>
                                    </select>
                                    <select id="year-filter" class="bg-slate-700 text-slate-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                        <option value="all">All Years</option>
                                    </select>
                                </div>
                            </div>
                            <ul id="expenses-list">
                                <!-- Expenses will be dynamically added here -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics-tab" class="tab-content w-full max-w-4xl mx-auto hidden">
            <h2 class="text-3xl font-bold text-amber-500 mb-6">Analytics</h2>
            <div class="grid md:grid-cols-2 gap-8">
                <!-- Charts Section -->
                <div class="bg-slate-800 p-6 rounded-lg shadow-xl border border-slate-700">
                    <h3 class="text-xl font-bold text-slate-300 mb-4">Your Financial Journey</h3>
                    <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-4">
                        <h4 id="chart-title" class="text-center text-md font-semibold text-slate-300 mb-4 md:mb-0">Category Breakdown</h4>
                        <div class="flex flex-wrap gap-2 justify-center">
                            <button data-chart-type="category" class="chart-btn px-4 py-2 rounded-lg font-medium shadow-md transition-colors duration-200 bg-amber-500 text-slate-900">Category</button>
                            <button data-chart-type="monthly" class="chart-btn px-4 py-2 rounded-lg font-medium shadow-md transition-colors duration-200 bg-slate-700 hover:bg-slate-600 text-slate-300">Monthly</button>
                            <button data-chart-type="daily" class="chart-btn px-4 py-2 rounded-lg font-medium shadow-md transition-colors duration-200 bg-slate-700 hover:bg-slate-600 text-slate-300">Daily</button>
                        </div>
                    </div>
                    <div class="chart-container h-80">
                        <canvas id="main-chart-canvas"></canvas>
                    </div>
                    <div class="flex justify-end mt-4">
                        <button id="export-json-btn" class="px-4 py-2 bg-slate-700 text-slate-300 font-medium rounded-lg shadow-md transition-colors duration-200 hover:bg-slate-600 mr-2">Export JSON</button>
                        <button id="export-csv-btn" class="px-4 py-2 bg-slate-700 text-slate-300 font-medium rounded-lg shadow-md transition-colors duration-200 hover:bg-slate-600">Export CSV</button>
                    </div>
                </div>

                <!-- Logs Section -->
                <div class="bg-slate-800 p-6 rounded-lg shadow-xl border border-slate-700">
                    <h3 class="text-xl font-bold text-slate-300 mb-4">User Logs</h3>
                    <p class="text-xs text-slate-500 mb-4">User ID: <span id="user-id-display"></span></p>
                    <div class="h-96 overflow-y-auto">
                        <ul id="logs-list" class="space-y-2">
                            <!-- Logs will be dynamically added here -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </main>
</body>

</html>
