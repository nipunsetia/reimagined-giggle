<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Avarta - Expense Tracker</title>
  
  <!-- Tailwind CSS CDN for styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Inter font from Google Fonts -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
  
  <!-- React and ReactDOM from CDN -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- Babel for JSX transformation in the browser -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Firebase JS SDK v11.6.1 for modular syntax -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // Global variables to be used by the React component
    window.firebase = {
      initializeApp,
      getAuth,
      signInAnonymously,
      signInWithCustomToken,
      onAuthStateChanged,
      getFirestore,
      doc,
      getDoc,
      setDoc,
      onSnapshot,
      collection,
      query,
      where,
      addDoc,
      deleteDoc
    };

    // Global variables provided by the Canvas environment
    window.__app_id = window.__app_id || 'default-app-id';
    window.__firebase_config = window.__firebase_config || '{}';
    window.__initial_auth_token = window.__initial_auth_token || null;
  </script>
  
  <style>
    /* Use Inter font globally */
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>
<body class="bg-gray-100">
  <div id="root"></div>

  <script type="text/jsx">
    // React hooks
    const { useState, useEffect } = React;
    
    // Helper function to format date to YYYY-MM
    const formatDate = (timestamp) => {
      const date = new Date(timestamp);
      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
    };

    // Lucide Icons (as inline SVGs to avoid import issues)
    const Plus = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
    );
    const Trash2 = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
    );
    const Copy = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
    );
    const Eye = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>
    );
    const EyeOff = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-10-7-10-7a1.8 1.8 0 0 1 1.77-1.46"></path><path d="M12 9a3 3 0 0 0-3 3"></path><path d="M3.18 3.18A19.98 19.98 0 0 1 12 5c7 0 10 7 10 7a1.8 1.8 0 0 1-1.77 1.46"></path><line x1="2" y1="2" x2="22" y2="22"></line></svg>
    );
    const User = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
    );


    // Main App Component
    function App() {
      const [db, setDb] = useState(null);
      const [auth, setAuth] = useState(null);
      const [userId, setUserId] = useState(null);
      const [expenses, setExpenses] = useState([]);
      const [description, setDescription] = useState('');
      const [amount, setAmount] = useState('');
      const [loading, setLoading] = useState(true);
      const [username, setUsername] = useState('');
      const [message, setMessage] = useState('');
      const [showUsername, setShowUsername] = useState(false);
      const [totalExpenses, setTotalExpenses] = useState(0);
      const [selectedMonth, setSelectedMonth] = useState('');
      const [filteredExpenses, setFilteredExpenses] = useState([]);
      const [isAuthReady, setIsAuthReady] = useState(false);
      const [currentUsername, setCurrentUsername] = useState('');

      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

      // Memoize the list of months for the dropdown
      const months = React.useMemo(() => {
        const today = new Date();
        const startYear = 2021;
        const currentYear = today.getFullYear();
        const currentMonth = today.getMonth();
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const monthOptions = [];

        for (let year = currentYear; year >= startYear; year--) {
          const endMonth = year === currentYear ? currentMonth : 11;
          for (let month = endMonth; month >= 0; month--) {
            monthOptions.push({
              value: `${year}-${String(month + 1).padStart(2, '0')}`,
              label: `${monthNames[month]} ${year}`
            });
          }
        }
        return monthOptions;
      }, []);

      // 1. Firebase Initialization and Authentication
      useEffect(() => {
        const initializeFirebase = async () => {
          try {
            const firebaseConfig = JSON.parse(window.__firebase_config);
            const app = window.firebase.initializeApp(firebaseConfig);
            const authService = window.firebase.getAuth(app);
            const firestoreDb = window.firebase.getFirestore(app);
            setDb(firestoreDb);
            setAuth(authService);
    
            const unsubscribe = window.firebase.onAuthStateChanged(authService, async (user) => {
              if (user) {
                setUserId(user.uid);
                setMessage('');

                // Fetch username if exists
                const userRef = window.firebase.doc(firestoreDb, `artifacts/${appId}/users/${user.uid}/profile/details`);
                const userDoc = await window.firebase.getDoc(userRef);
                if (userDoc.exists()) {
                  setCurrentUsername(userDoc.data().username);
                }
              } else {
                setUserId(null);
                setCurrentUsername('');
              }
              setIsAuthReady(true);
            });
    
            // Use custom token if available, otherwise sign in anonymously
            if (window.__initial_auth_token) {
              await window.firebase.signInWithCustomToken(authService, window.__initial_auth_token);
            } else {
              await window.firebase.signInAnonymously(authService);
            }
    
            return () => unsubscribe();
          } catch (error) {
            console.error("Firebase initialization error:", error);
            setMessage(`Initialization failed. Please check the console for details. Error: ${error.message}`);
            setLoading(false);
          }
        };

        if (window.firebase) {
          initializeFirebase();
        } else {
          setMessage('Firebase SDK not loaded. Please wait...');
        }
      }, []);


      // 2. Fetch and listen to expenses
      useEffect(() => {
        if (db && userId && isAuthReady) {
          const expensesCollectionPath = `artifacts/${appId}/users/${userId}/expenses`;
          const q = window.firebase.collection(db, expensesCollectionPath);

          const unsubscribe = window.firebase.onSnapshot(q, (querySnapshot) => {
            const expensesData = [];
            querySnapshot.forEach((doc) => {
              expensesData.push({ id: doc.id, ...doc.data() });
            });
            expensesData.sort((a, b) => b.timestamp - a.timestamp);
            setExpenses(expensesData);
            setLoading(false);
          }, (error) => {
            console.error("Error fetching expenses:", error);
            setMessage(`Failed to load expenses. Error: ${error.message}`);
            setLoading(false);
          });

          return () => unsubscribe();
        }
      }, [db, userId, isAuthReady, appId]);

      // 3. Filter expenses and calculate total for the selected month
      useEffect(() => {
        if (expenses.length > 0) {
          const currentMonth = selectedMonth || formatDate(Date.now());
          const filtered = expenses.filter(expense => formatDate(expense.timestamp) === currentMonth);
          const total = filtered.reduce((sum, expense) => sum + expense.amount, 0);
          setFilteredExpenses(filtered);
          setTotalExpenses(total);
        } else {
          setFilteredExpenses([]);
          setTotalExpenses(0);
        }
      }, [expenses, selectedMonth]);


      const createUsername = async () => {
        if (!username) {
          setMessage('Please enter a username.');
          return;
        }

        try {
          // Check if username is unique
          const usernamesRef = window.firebase.collection(db, `artifacts/${appId}/public/data/usernames`);
          const q = window.firebase.query(usernamesRef, window.firebase.where('username', '==', username));
          const querySnapshot = await window.firebase.getDocs(q);
          
          if (!querySnapshot.empty) {
             setMessage('Username already exists. Please choose another one.');
             return;
          }

          // Save username to public collection
          const userRef = window.firebase.doc(db, `artifacts/${appId}/users/${userId}/profile/details`);
          await window.firebase.setDoc(userRef, { username });

          // Save the username mapping in a public collection
          const usernameDocRef = window.firebase.doc(db, `artifacts/${appId}/public/data/usernames/${userId}`);
          await window.firebase.setDoc(usernameDocRef, { username, userId });

          setCurrentUsername(username);
          setUsername('');
          setMessage('Username created successfully!');
        } catch (e) {
          console.error("Error creating username: ", e);
          setMessage(`Error: Could not create username. ${e.message}`);
        }
      };


      const addExpense = async () => {
        if (!description || !amount || !userId) {
          setMessage('Please enter a description and amount. You must be logged in.');
          return;
        }
        
        const numericAmount = parseFloat(amount);
        if (isNaN(numericAmount) || numericAmount <= 0) {
          setMessage('Please enter a valid positive number for the amount.');
          return;
        }

        try {
          const expensesCollectionPath = `artifacts/${appId}/users/${userId}/expenses`;
          await window.firebase.addDoc(window.firebase.collection(db, expensesCollectionPath), {
            description: description,
            amount: numericAmount,
            timestamp: Date.now(),
          });
          setDescription('');
          setAmount('');
          setMessage('Expense saved!');
        } catch (e) {
          console.error("Error adding document: ", e);
          setMessage(`Error: Could not save expense. ${e.message}`);
        }
      };

      const deleteExpense = async (id) => {
        if (!userId) {
          setMessage('You must be logged in to delete expenses.');
          return;
        }

        try {
          const docRef = window.firebase.doc(db, `artifacts/${appId}/users/${userId}/expenses`, id);
          await window.firebase.deleteDoc(docRef);
          setMessage('Expense deleted.');
        } catch (e) {
          console.error("Error removing document: ", e);
          setMessage(`Error: Could not delete expense. ${e.message}`);
        }
      };

      const MessageBox = ({ message, onClose }) => (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50">
          <div className="w-full max-w-sm p-6 bg-white rounded-lg shadow-2xl">
            <p className="text-gray-800">{message}</p>
            <div className="mt-4 text-right">
              <button
                onClick={onClose}
                className="px-4 py-2 text-sm font-semibold text-white transition-colors bg-blue-500 rounded-md hover:bg-blue-600"
              >
                OK
              </button>
            </div>
          </div>
        </div>
      );

      return (
        <div className="flex items-center justify-center min-h-screen bg-gray-100 font-inter">
          <div className="w-full max-w-lg p-8 m-4 bg-white rounded-xl shadow-2xl transition-all duration-300">
            <div className="flex items-center justify-center mb-6">
              <h1 className="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-500 to-indigo-600">
                Avarta
              </h1>
            </div>
            
            {isAuthReady && !currentUsername ? (
              <div className="mb-6 space-y-4">
                <label className="block text-sm font-medium text-gray-700">
                  Create a Unique Username
                </label>
                <div className="relative flex items-center space-x-2">
                  <input
                    type="text"
                    className="flex-1 block w-full p-3 text-sm text-gray-900 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm"
                    placeholder="e.g., JaneDoe123"
                    value={username}
                    onChange={(e) => setUsername(e.target.value)}
                  />
                  <button
                    onClick={createUsername}
                    disabled={!username}
                    className="px-4 py-2 text-sm font-semibold text-white transition-colors duration-200 bg-green-500 rounded-lg shadow-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 disabled:opacity-50"
                  >
                    Create
                  </button>
                </div>
              </div>
            ) : (
              <div className="mb-6 p-4 rounded-lg bg-gray-50 shadow-inner">
                <div className="flex items-center justify-between">
                  <div className="flex items-center space-x-2">
                    <User />
                    <p className="text-sm font-semibold text-gray-800">User: {currentUsername || 'Loading...'}</p>
                  </div>
                  <div className="flex items-center space-x-2">
                    <span className="text-sm font-medium text-gray-600">Total:</span>
                    <span className="text-xl font-bold text-gray-900">${totalExpenses.toFixed(2)}</span>
                  </div>
                </div>
                <div className="mt-4">
                  <label htmlFor="month-select" className="block text-sm font-medium text-gray-700">
                    Filter by Month
                  </label>
                  <select
                    id="month-select"
                    value={selectedMonth}
                    onChange={(e) => setSelectedMonth(e.target.value)}
                    className="block w-full p-2 mt-1 text-sm text-gray-900 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                  >
                    <option value="">All Time</option>
                    {months.map(month => (
                      <option key={month.value} value={month.value}>{month.label}</option>
                    ))}
                  </select>
                </div>
              </div>
            )}


            <div className="mb-6 p-4 rounded-lg bg-gray-50 shadow-inner">
              <h2 className="mb-4 text-xl font-semibold text-gray-800">Add New Expense</h2>
              <div className="space-y-4">
                <input
                  type="text"
                  placeholder="Description (e.g., Coffee)"
                  className="block w-full p-3 text-sm text-gray-900 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm"
                  value={description}
                  onChange={(e) => setDescription(e.target.value)}
                />
                <input
                  type="number"
                  placeholder="Amount (e.g., 4.50)"
                  className="block w-full p-3 text-sm text-gray-900 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm"
                  value={amount}
                  onChange={(e) => setAmount(e.target.value)}
                />
                <button
                  onClick={addExpense}
                  disabled={!userId || !currentUsername}
                  className="flex items-center justify-center w-full px-4 py-3 text-sm font-semibold text-white transition-colors duration-200 bg-blue-600 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50"
                >
                  <span className="mr-2"><Plus /></span>
                  Add Expense
                </button>
              </div>
            </div>

            <h2 className="mb-4 text-xl font-semibold text-gray-800">
              {selectedMonth ? `Expenses for ${months.find(m => m.value === selectedMonth)?.label}` : "All Expenses"}
            </h2>
            {loading ? (
              <p className="p-4 text-sm text-center text-gray-500 bg-gray-50 rounded-lg">Loading expenses...</p>
            ) : filteredExpenses.length > 0 ? (
              <ul className="space-y-3">
                {filteredExpenses.map((expense) => (
                  <li
                    key={expense.id}
                    className="flex items-center justify-between p-4 transition-all duration-200 bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md"
                  >
                    <div>
                      <p className="text-sm font-medium text-gray-900">{expense.description}</p>
                      <p className="text-lg font-bold text-gray-700">
                        ${expense.amount.toFixed(2)}
                      </p>
                    </div>
                    <button
                      onClick={() => deleteExpense(expense.id)}
                      className="p-2 transition-colors duration-200 bg-red-100 rounded-full text-red-500 hover:bg-red-200"
                      aria-label="Delete expense"
                    >
                      <Trash2 />
                    </button>
                  </li>
                ))}
              </ul>
            ) : (
              <p className="p-4 text-sm text-center text-gray-500 bg-gray-50 rounded-lg">
                No expenses found for this period.
              </p>
            )}
          </div>

          {message && <MessageBox message={message} onClose={() => setMessage('')} />}
        </div>
      );
    }

    const container = document.getElementById('root');
    const root = ReactDOM.createRoot(container);
    root.render(<App />);
  </script>
</body>
</html>
