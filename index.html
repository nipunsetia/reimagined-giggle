<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Āvarta: Finance Flow</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, deleteDoc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Initialize Firebase
        let app;
        let db;
        let auth;
        let userId = null;
        let chartInstance;

        // Message box utility to replace alert()
        const showMessageBox = (title, message) => {
            document.getElementById('message-title').textContent = title;
            document.getElementById('message-text').textContent = message;
            document.getElementById('message-box').classList.remove('hidden');
        };

        document.getElementById('close-message-btn').addEventListener('click', () => {
            document.getElementById('message-box').classList.add('hidden');
        });

        // AI Assistant utilities
        const aiAssistantModal = document.getElementById('ai-assistant-modal');
        const aiInput = document.getElementById('ai-input');
        const aiSendBtn = document.getElementById('ai-send-btn');
        const aiResponseArea = document.getElementById('ai-response-area');
        const aiChatContainer = document.createElement('div');
        aiChatContainer.className = 'flex flex-col space-y-4';
        aiResponseArea.innerHTML = '';
        aiResponseArea.appendChild(aiChatContainer);

        const addMessageToChat = (text, sender) => {
            const messageElement = document.createElement('div');
            messageElement.className = `p-3 rounded-lg ${sender === 'user' ? 'bg-amber-600 text-slate-900 self-end' : 'bg-slate-700 text-slate-200 self-start'}`;
            messageElement.textContent = text;
            aiChatContainer.appendChild(messageElement);
            aiResponseArea.scrollTop = aiResponseArea.scrollHeight;
        };

        let chatHistory = [{ role: "model", parts: [{ text: "Hello! I am your personal financial assistant. I can help you with your finances by analyzing your data. How can I help you today?" }] }];
        addMessageToChat(chatHistory[0].parts[0].text, 'assistant');

        const getAiResponse = async (prompt) => {
            addMessageToChat(prompt, 'user');
            aiInput.value = '';
            aiInput.disabled = true;
            aiSendBtn.disabled = true;
            addMessageToChat('Thinking...', 'assistant');

            try {
                let currentRetries = 0;
                const maxRetries = 5;
                const initialDelay = 1000;

                const makeApiCall = async () => {
                    const payload = {
                        contents: chatHistory,
                    };

                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API call failed with status: ${response.status}`);
                    }

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        chatHistory.push({ role: "model", parts: [{ text: text }] });
                        // Replace 'Thinking...' with the actual response
                        const lastMessage = aiChatContainer.lastChild;
                        lastMessage.textContent = text;
                        aiResponseArea.scrollTop = aiResponseArea.scrollHeight;
                    } else {
                        throw new Error('Unexpected API response structure.');
                    }
                };

                const retryApiCall = async () => {
                    try {
                        await makeApiCall();
                    } catch (error) {
                        console.error('API call failed:', error);
                        if (currentRetries < maxRetries) {
                            const delay = initialDelay * Math.pow(2, currentRetries);
                            currentRetries++;
                            setTimeout(retryApiCall, delay);
                        } else {
                            const lastMessage = aiChatContainer.lastChild;
                            lastMessage.textContent = "Sorry, I couldn't get a response. Please try again later.";
                            aiResponseArea.scrollTop = aiResponseArea.scrollHeight;
                        }
                    }
                };

                await retryApiCall();

            } catch (error) {
                console.error('Error fetching AI response:', error);
                const lastMessage = aiChatContainer.lastChild;
                lastMessage.textContent = "Sorry, I couldn't get a response. Please try again later.";
                aiResponseArea.scrollTop = aiResponseArea.scrollHeight;
            } finally {
                aiInput.disabled = false;
                aiSendBtn.disabled = false;
                aiInput.focus();
            }
        };

        aiSendBtn.addEventListener('click', () => {
            const prompt = aiInput.value.trim();
            if (prompt) {
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                getAiResponse(prompt);
            }
        });
        aiInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                aiSendBtn.click();
            }
        });

        // Main app logic
        window.addEventListener('load', async () => {
            if (Object.keys(firebaseConfig).length > 0) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('username-modal').classList.add('hidden');
                        
                        // Check if a username is set
                        const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
                        const userDocSnap = await getDoc(userDocRef);
                        
                        if (userDocSnap.exists()) {
                            const userData = userDocSnap.data();
                            document.getElementById('username-display').textContent = userData.username;
                            setupRealtimeListeners();
                        } else {
                            document.getElementById('username-modal').classList.remove('hidden');
                        }
                    } else {
                        // Sign in anonymously if no user and no custom token
                        if (initialAuthToken) {
                            try {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } catch (error) {
                                console.error("Error signing in with custom token:", error);
                                await signInAnonymously(auth);
                            }
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } else {
                console.warn("Firebase configuration is missing. The application will run without database functionality.");
                showMessageBox("Firebase Error", "Firebase configuration is missing. Data persistence will not work. Please check your environment setup.");
                // Disable recurring expense toggle and form submit
                document.getElementById('recurring-checkbox').disabled = true;
                document.getElementById('recurring-toggle-label').classList.add('disabled');
                document.getElementById('expense-form').querySelector('button').disabled = true;
                document.getElementById('budget-form').querySelector('button').disabled = true;
            }
        });

        const setupRealtimeListeners = () => {
            // Expenses listener
            const expensesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/expenses`);
            onSnapshot(expensesCollectionRef, (snapshot) => {
                const expenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateExpenseTable(expenses);
                updateChart(expenses);
            });

            // Budget listener
            const budgetDocRef = doc(db, `artifacts/${appId}/users/${userId}/budget/data`);
            onSnapshot(budgetDocRef, (doc) => {
                if (doc.exists()) {
                    const budget = doc.data().monthlyBudget;
                    document.getElementById('current-budget').textContent = `${budget.toLocaleString()} ${document.getElementById('expense-currency').value}`;
                } else {
                    document.getElementById('current-budget').textContent = 'Not Set';
                }
            });
        };

        // Utility functions
        const showModal = (id) => document.getElementById(id).classList.remove('hidden');
        const hideModal = (id) => document.getElementById(id).classList.add('hidden');

        // Form handling
        const expenseForm = document.getElementById('expense-form');
        expenseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userId) {
                showMessageBox("Error", "User not authenticated. Please log in or wait for the anonymous sign-in process to complete.");
                return;
            }
            const name = document.getElementById('expense-name').value;
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const currency = document.getElementById('expense-currency').value;
            const category = document.getElementById('expense-category').value;
            const date = document.getElementById('expense-date').value;
            const isRecurring = document.getElementById('recurring-checkbox').checked;

            if (isNaN(amount) || amount <= 0) {
                showMessageBox("Invalid Input", "Please enter a valid amount.");
                return;
            }

            const expenseData = {
                name,
                amount,
                currency,
                category,
                date,
                isRecurring,
                timestamp: new Date().toISOString()
            };

            const expensesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/expenses`);
            try {
                await addDoc(expensesCollectionRef, expenseData);
                expenseForm.reset();
                updateRecurringOptions(); // Reset recurring options display
                document.getElementById('recurring-options-container').classList.add('hidden');
                showMessageBox("Success", "Expense added successfully!");
            } catch (error) {
                console.error("Error adding expense:", error);
                showMessageBox("Error", "Could not add expense. Please try again.");
            }
        });

        const budgetForm = document.getElementById('budget-form');
        budgetForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userId) {
                showMessageBox("Error", "User not authenticated.");
                return;
            }
            const budgetAmount = parseFloat(document.getElementById('budget-amount').value);
            if (isNaN(budgetAmount) || budgetAmount <= 0) {
                showMessageBox("Invalid Input", "Please enter a valid budget amount.");
                return;
            }

            const budgetDocRef = doc(db, `artifacts/${appId}/users/${userId}/budget/data`);
            try {
                await setDoc(budgetDocRef, { monthlyBudget: budgetAmount }, { merge: true });
                showMessageBox("Success", "Budget set successfully!");
            } catch (error) {
                console.error("Error setting budget:", error);
                showMessageBox("Error", "Could not set budget. Please try again.");
            }
        });
        
        const deleteExpense = async (expenseId) => {
            if (!userId) {
                showMessageBox("Error", "User not authenticated.");
                return;
            }
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/expenses`, expenseId);
                await deleteDoc(docRef);
                showMessageBox("Success", "Expense deleted successfully.");
            } catch (error) {
                console.error("Error deleting document:", error);
                showMessageBox("Error", "Could not delete expense. Please try again.");
            }
        };

        const updateExpenseTable = (expenses) => {
            const tableBody = document.getElementById('expense-table-body');
            tableBody.innerHTML = '';
            expenses.sort((a, b) => new Date(b.date) - new Date(a.date));

            expenses.forEach(expense => {
                const row = document.createElement('tr');
                row.className = 'border-b border-slate-700 hover:bg-slate-700 transition-colors duration-200';
                row.innerHTML = `
                    <td class="p-3 text-sm text-slate-300 rounded-l-lg">${expense.name}</td>
                    <td class="p-3 text-sm text-slate-300">${expense.amount.toLocaleString()} ${expense.currency}</td>
                    <td class="p-3 text-sm text-slate-300">${expense.category}</td>
                    <td class="p-3 text-sm text-slate-300">${expense.date}</td>
                    <td class="p-3 text-sm text-slate-300">${expense.isRecurring ? 'Yes' : 'No'}</td>
                    <td class="p-3 text-sm text-right rounded-r-lg">
                        <button class="text-red-500 hover:text-red-400 font-semibold" data-id="${expense.id}">Delete</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            tableBody.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const expenseId = e.target.dataset.id;
                    deleteExpense(expenseId);
                });
            });
        };

        const updateChart = (expenses) => {
            const ctx = document.getElementById('expense-chart').getContext('2d');
            
            // Destroy previous chart instance if it exists
            if (chartInstance) {
                chartInstance.destroy();
            }

            const expensesByCategory = expenses.reduce((acc, expense) => {
                acc[expense.category] = (acc[expense.category] || 0) + expense.amount;
                return acc;
            }, {});

            const labels = Object.keys(expensesByCategory);
            const data = Object.values(expensesByCategory);
            const backgroundColors = [
                '#f59e0b', '#ef4444', '#3b82f6', '#10b981', '#6366f1', '#f97316', '#a855f7'
            ];

            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        hoverOffset: 4,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#e2e8f0',
                                font: {
                                    family: 'Inter'
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Expenses by Category',
                            color: '#e2e8f0',
                            font: {
                                size: 18,
                                family: 'Inter'
                            }
                        }
                    },
                    cutout: '70%'
                }
            });
        };

        // UI event listeners
        const showLogBtn = document.getElementById('show-log-btn');
        const closeLogBtn = document.getElementById('close-log-btn');
        const showAiBtn = document.getElementById('show-ai-btn');
        const closeAiBtn = document.getElementById('close-ai-assistant-btn');
        const exportBtn = document.getElementById('export-btn');
        const closeExportBtn = document.getElementById('close-export-btn');
        const usernameForm = document.getElementById('username-form');
        const usernameInput = document.getElementById('username-input');

        showLogBtn.addEventListener('click', () => showModal('activity-log-modal'));
        closeLogBtn.addEventListener('click', () => hideModal('activity-log-modal'));
        if (showAiBtn) {
            showAiBtn.addEventListener('click', () => showModal('ai-assistant-modal'));
        }
        if (closeAiBtn) {
            closeAiBtn.addEventListener('click', () => hideModal('ai-assistant-modal'));
        }
        exportBtn.addEventListener('click', () => showModal('export-modal'));
        closeExportBtn.addEventListener('click', () => hideModal('export-modal'));

        usernameForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = usernameInput.value.trim();
            if (username) {
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
                try {
                    await setDoc(userDocRef, { username: username });
                    document.getElementById('username-display').textContent = username;
                    hideModal('username-modal');
                    setupRealtimeListeners();
                } catch (error) {
                    console.error("Error setting username:", error);
                    showMessageBox("Error", "Could not set username. Please try again.");
                }
            }
        });
        
        // Dynamic quote and AI suggestions section
        const dynamicQuoteElement = document.getElementById('dynamic-quote');
        const aiSuggestionArea = document.getElementById('ai-suggestion-area');

        const getDynamicQuote = async () => {
            // We can add a function here to fetch a quote from a public API
            // For now, let's use a static quote.
            dynamicQuoteElement.textContent = "“Do not save what is left after spending, but spend what is left after saving.” – Warren Buffett";
        };

        const getAiSuggestions = async () => {
             // Function to get suggestions from the AI
             if (!userId) return;
             aiSuggestionArea.innerHTML = 'Loading suggestions...';

             try {
                // Fetch the latest expenses for the prompt
                const q = collection(db, `artifacts/${appId}/users/${userId}/expenses`);
                const querySnapshot = await getDocs(q);
                const expenses = querySnapshot.docs.map(doc => doc.data());
                const expensesText = JSON.stringify(expenses, null, 2);

                const prompt = `Based on the following user expenses, provide 3 to 4 short financial tips and suggestions. Keep each tip concise (one sentence) and format them as a bulleted list.

                User Expenses:
                ${expensesText}
                `;

                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }]
                };

                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || "No suggestions available at the moment.";
                
                // Format the text from the model as a bulleted list for the UI
                const formattedText = text.split('\n').map(item => `<li class="flex items-start"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-amber-500 mr-2 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span>${item.replace(/^- /, '')}</span></li>`).join('');
                aiSuggestionArea.innerHTML = `<ul class="space-y-2">${formattedText}</ul>`;

             } catch (error) {
                console.error("Error fetching AI suggestions:", error);
                aiSuggestionArea.innerHTML = `<p class="text-red-400">Failed to load suggestions. Please check your network connection.</p>`;
             }
        };

        document.getElementById('fetch-suggestions-btn').addEventListener('click', getAiSuggestions);

        // Export data functionality
        document.getElementById('export-csv-btn').addEventListener('click', async () => {
            if (!userId) {
                showMessageBox("Error", "User not authenticated.");
                return;
            }
            try {
                const q = collection(db, `artifacts/${appId}/users/${userId}/expenses`);
                const querySnapshot = await getDocs(q);
                const expenses = querySnapshot.docs.map(doc => doc.data());

                if (expenses.length === 0) {
                    showMessageBox("Export Failed", "No expense data to export.");
                    return;
                }

                const headers = Object.keys(expenses[0]).join(',');
                const csvRows = expenses.map(e => Object.values(e).map(val => `"${val}"`).join(','));
                const csvString = [headers, ...csvRows].join('\n');
                
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `finance_flow_expenses_${new Date().toISOString()}.csv`;
                link.click();
                URL.revokeObjectURL(link.href);

                hideModal('export-modal');
                showMessageBox("Success", "Data exported successfully to CSV!");
            } catch (error) {
                console.error("Error exporting to CSV:", error);
                showMessageBox("Error", "Could not export data. Please try again.");
            }
        });

        document.getElementById('export-json-btn').addEventListener('click', async () => {
            if (!userId) {
                showMessageBox("Error", "User not authenticated.");
                return;
            }
            try {
                const q = collection(db, `artifacts/${appId}/users/${userId}/expenses`);
                const querySnapshot = await getDocs(q);
                const expenses = querySnapshot.docs.map(doc => doc.data());

                if (expenses.length === 0) {
                    showMessageBox("Export Failed", "No expense data to export.");
                    return;
                }

                const jsonString = JSON.stringify(expenses, null, 2);
                
                const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `finance_flow_expenses_${new Date().toISOString()}.json`;
                link.click();
                URL.revokeObjectURL(link.href);

                hideModal('export-modal');
                showMessageBox("Success", "Data exported successfully to JSON!");
            } catch (error) {
                console.error("Error exporting to JSON:", error);
                showMessageBox("Error", "Could not export data. Please try again.");
            }
        });


        // Other UI logic from the original file
        const expenseNameInput = document.getElementById('expense-name');
        const expenseAmountInput = document.getElementById('expense-amount');
        const recurringCheckbox = document.getElementById('recurring-checkbox');
        const recurringToggleLabel = document.getElementById('recurring-toggle-label');
        const recurringOptionsContainer = document.getElementById('recurring-options-container');
        const recurrenceFreqRadios = document.querySelectorAll('input[name="recurrence-freq"]');
        const weeklyOptions = document.getElementById('weekly-options');
        const monthlyOptions = document.getElementById('monthly-options');

        const checkFormValidity = () => {
            const nameFilled = expenseNameInput.value.trim() !== '';
            const amountFilled = expenseAmountInput.value.trim() !== '';
            
            if (nameFilled && amountFilled) {
                recurringCheckbox.disabled = false;
                recurringToggleLabel.classList.remove('disabled');
            } else {
                recurringCheckbox.disabled = true;
                recurringCheckbox.checked = false;
                recurringToggleLabel.classList.add('disabled');
                recurringOptionsContainer.classList.add('hidden');
            }
        };

        const updateRecurringOptions = () => {
            const frequency = document.querySelector('input[name="recurrence-freq"]:checked').value;
            weeklyOptions.classList.add('hidden');
            monthlyOptions.classList.add('hidden');
            
            if (frequency === 'weekly') {
                weeklyOptions.classList.remove('hidden');
            } else if (frequency === 'monthly') {
                monthlyOptions.classList.remove('hidden');
            }
        };

        expenseNameInput.addEventListener('input', checkFormValidity);
        expenseAmountInput.addEventListener('input', checkFormValidity);

        recurringCheckbox.addEventListener('change', () => {
            if (recurringCheckbox.checked) {
                recurringOptionsContainer.classList.remove('hidden');
                updateRecurringOptions();
            } else {
                recurringOptionsContainer.classList.add('hidden');
            }
        });

        recurrenceFreqRadios.forEach(radio => {
            radio.addEventListener('change', updateRecurringOptions);
        });

        // Add days 1-31 to monthly dropdown
        const monthlyDaySelect = document.getElementById('monthly-day-select');
        for (let i = 1; i <= 31; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = i;
            monthlyDaySelect.appendChild(option);
        }

        // Initial call to get the quote
        getDynamicQuote();

    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body {
            font-family: 'Poppins', 'Inter', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1e293b;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        .recurring-toggle-switch {
            width: 44px;
            height: 24px;
            position: relative;
        }
        .recurring-toggle-switch input {
            display: none;
        }
        .recurring-toggle-switch .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #475569;
            transition: .4s;
            border-radius: 34px;
        }
        .recurring-toggle-switch .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        .recurring-toggle-switch input:checked + .slider {
            background-color: #22c55e;
        }
        .recurring-toggle-switch input:checked + .slider:before {
            transform: translateX(20px);
        }
        .recurring-toggle-switch.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .recurring-toggle-switch.disabled .slider {
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-200">
    <!-- Main Application Container -->
    <main class="min-h-screen p-4 md:p-8 flex flex-col items-center">
        <!-- Header Section -->
        <header class="w-full max-w-7xl flex flex-col md:flex-row justify-between items-center mb-6">
            <div class="flex items-center mb-4 md:mb-0">
                <!-- Updated, more relaxed logo SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M12 2a10 10 0 0 1 10 10"></path>
                    <path d="M12 2a10 10 0 0 0 10 10"></path>
                    <path d="M12 2a10 10 0 0 0-10 10"></path>
                </svg>
                <h1 class="text-3xl font-bold text-amber-500">Āvarta: Finance Flow</h1>
            </div>
            <div class="flex flex-col md:flex-row items-center space-y-2 md:space-y-0 md:space-x-4">
                <div class="flex items-center space-x-2">
                    <span class="text-sm">User:</span>
                    <span id="username-display" class="font-semibold text-amber-500">Guest</span>
                </div>
                <button id="show-log-btn" class="bg-slate-700 text-slate-300 hover:bg-slate-600 px-4 py-2 rounded-lg font-medium shadow-md transition-colors duration-200">Activity Log</button>
                <button id="export-btn" class="bg-slate-700 text-slate-300 hover:bg-slate-600 px-4 py-2 rounded-lg font-medium shadow-md transition-colors duration-200">Export Data</button>
                <button id="show-ai-btn" class="bg-slate-700 text-slate-300 hover:bg-slate-600 px-4 py-2 rounded-lg font-medium shadow-md transition-colors duration-200">AI Assistant</button>
            </div>
        </header>

        <!-- Message/Alert Box (Custom, not alert()) -->
        <div id="message-box" class="hidden fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-80 bg-slate-800 text-slate-200 p-6 rounded-lg shadow-2xl z-50 border border-slate-700 transition-opacity duration-300">
            <h3 id="message-title" class="font-bold text-lg mb-2 text-amber-500"></h3>
            <p id="message-text" class="text-slate-300 mb-4"></p>
            <div class="flex justify-end">
                <button id="close-message-btn" class="bg-amber-500 text-slate-900 font-semibold px-4 py-2 rounded-lg hover:bg-amber-600 transition-colors duration-200">OK</button>
            </div>
        </div>

        <!-- Username Modal -->
        <div id="username-modal" class="fixed inset-0 bg-slate-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
            <div class="bg-slate-800 p-8 rounded-lg shadow-xl max-w-md w-full border border-slate-700">
                <h2 class="text-2xl font-bold mb-4 text-amber-500">Set Your Username</h2>
                <p class="text-slate-300 mb-4">Please enter a username to get started. This will be used to personalize your experience and retrieve your data.</p>
                <form id="username-form" class="space-y-4">
                    <div class="flex space-x-2">
                        <input type="text" id="username-input" class="w-full p-3 rounded-lg bg-slate-700 text-slate-200 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="Your Name" required>
                    </div>
                    <button type="submit" class="w-full bg-amber-500 text-slate-900 font-bold p-3 rounded-lg hover:bg-amber-600 transition-colors duration-200">Save Username</button>
                </form>
            </div>
        </div>

        <!-- AI Assistant Modal -->
        <div id="ai-assistant-modal" class="hidden fixed inset-0 bg-slate-900 bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-slate-800 p-8 rounded-lg shadow-xl max-w-2xl w-full border border-slate-700">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-amber-500">AI Financial Assistant</h2>
                    <button id="close-ai-assistant-btn" class="text-slate-400 hover:text-slate-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div id="ai-response-area" class="h-80 overflow-y-auto custom-scrollbar bg-slate-700 p-4 rounded-lg text-slate-300 mb-4">
                    <!-- Chat messages will be appended here -->
                </div>
                <div class="flex items-center space-x-2">
                    <input type="text" id="ai-input" class="flex-grow p-3 rounded-lg bg-slate-700 text-slate-200 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="Type your question here...">
                    <button id="ai-send-btn" class="bg-amber-500 text-slate-900 font-bold p-3 rounded-lg hover:bg-amber-600 transition-colors duration-200">Send</button>
                </div>
            </div>
        </div>

        <!-- Activity Log Modal -->
        <div id="activity-log-modal" class="hidden fixed inset-0 bg-slate-900 bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-slate-800 p-8 rounded-lg shadow-xl max-w-2xl w-full border border-slate-700">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-amber-500">Activity Log</h2>
                    <button id="close-log-btn" class="text-slate-400 hover:text-slate-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div id="activity-log-content" class="h-80 overflow-y-auto custom-scrollbar bg-slate-700 p-4 rounded-lg text-slate-300">
                    <p>Log is empty.</p>
                </div>
            </div>
        </div>

        <!-- Export Modal -->
        <div id="export-modal" class="hidden fixed inset-0 bg-slate-900 bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-slate-800 p-8 rounded-lg shadow-xl max-w-md w-full border border-slate-700">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-amber-500">Export Data</h2>
                    <button id="close-export-btn" class="text-slate-400 hover:text-slate-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="space-y-4">
                    <p class="text-slate-300">Choose a format to export your financial data.</p>
                    <button id="export-csv-btn" class="w-full bg-emerald-500 text-slate-900 font-bold p-3 rounded-lg hover:bg-emerald-600 transition-colors duration-200">Export to CSV</button>
                    <button id="export-json-btn" class="w-full bg-emerald-500 text-slate-900 font-bold p-3 rounded-lg hover:bg-emerald-600 transition-colors duration-200">Export to JSON</button>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="w-full max-w-7xl grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column: Forms and Controls -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Add Expense Form -->
                <div class="bg-slate-800 p-6 rounded-lg shadow-xl border border-slate-700">
                    <h2 class="text-2xl font-bold text-amber-500 mb-4">Add Expense</h2>
                    <form id="expense-form" class="space-y-4">
                        <div>
                            <label for="expense-name" class="block text-slate-400 mb-1">Expense Name</label>
                            <input type="text" id="expense-name" class="w-full p-3 rounded-lg bg-slate-700 text-slate-200 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="e.g., Groceries" required>
                        </div>
                        <div>
                            <label for="expense-amount" class="block text-slate-400 mb-1">Amount</label>
                            <div class="flex rounded-lg border border-slate-600 focus-within:ring-2 focus-within:ring-amber-500">
                                <select id="expense-currency" class="p-3 bg-slate-700 text-slate-200 rounded-l-lg border-r border-slate-600 focus:outline-none">
                                    <option value="INR">INR ₹</option>
                                    <option value="USD">USD $</option>
                                    <option value="EUR">EUR €</option>
                                </select>
                                <input type="number" id="expense-amount" class="flex-grow p-3 bg-slate-700 text-slate-200 rounded-r-lg focus:outline-none" placeholder="e.g., 500" required>
                            </div>
                            <p id="amount-error" class="text-red-500 text-sm mt-1 hidden">Invalid amount. Please check the currency limits.</p>
                        </div>
                        <div>
                            <label for="expense-category" class="block text-slate-400 mb-1">Category</label>
                            <select id="expense-category" class="w-full p-3 rounded-lg bg-slate-700 text-slate-200 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-amber-500" required>
                                <option value="Food">Food</option>
                                <option value="Transport">Transport</option>
                                <option value="Bills">Bills</option>
                                <option value="Entertainment">Entertainment</option>
                                <option value="Shopping">Shopping</option>
                                <option value="Health">Health</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label for="expense-date" class="block text-slate-400 mb-1">Date</label>
                            <input type="date" id="expense-date" class="w-full p-3 rounded-lg bg-slate-700 text-slate-200 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-amber-500" required>
                        </div>
                        <div class="flex items-center space-x-2">
                            <label id="recurring-toggle-label" class="recurring-toggle-switch disabled">
                                <input type="checkbox" id="recurring-checkbox" disabled>
                                <span class="slider"></span>
                            </label>
                            <span id="recurring-label" class="text-slate-400">Recurring Expense</span>
                        </div>

                        <!-- Recurring options container, initially hidden -->
                        <div id="recurring-options-container" class="space-y-4 p-4 rounded-lg bg-slate-700 hidden">
                            <h3 class="text-lg font-semibold text-amber-500">Recurrence Frequency</h3>
                            <div class="flex space-x-4">
                                <label class="flex items-center space-x-2">
                                    <input type="radio" name="recurrence-freq" value="daily" class="form-radio text-amber-500 bg-slate-800 border-slate-600 focus:ring-amber-500" checked>
                                    <span class="text-slate-300">Daily</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="radio" name="recurrence-freq" value="weekly" class="form-radio text-amber-500 bg-slate-800 border-slate-600 focus:ring-amber-500">
                                    <span class="text-slate-300">Weekly</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="radio" name="recurrence-freq" value="monthly" class="form-radio text-amber-500 bg-slate-800 border-slate-600 focus:ring-amber-500">
                                    <span class="text-slate-300">Monthly</span>
                                </label>
                            </div>

                            <div id="weekly-options" class="flex flex-wrap gap-2 hidden">
                                <label class="flex items-center space-x-1 text-sm text-slate-300">
                                    <input type="checkbox" name="weekly-day" value="Mon" class="form-checkbox text-amber-500 rounded bg-slate-800 border-slate-600 focus:ring-amber-500">
                                    <span>Mon</span>
                                </label>
                                <label class="flex items-center space-x-1 text-sm text-slate-300">
                                    <input type="checkbox" name="weekly-day" value="Tue" class="form-checkbox text-amber-500 rounded bg-slate-800 border-slate-600 focus:ring-amber-500">
                                    <span>Tue</span>
                                </label>
                                <label class="flex items-center space-x-1 text-sm text-slate-300">
                                    <input type="checkbox" name="weekly-day" value="Wed" class="form-checkbox text-amber-500 rounded bg-slate-800 border-slate-600 focus:ring-amber-500">
                                    <span>Wed</span>
                                </label>
                                <label class="flex items-center space-x-1 text-sm text-slate-300">
                                    <input type="checkbox" name="weekly-day" value="Thu" class="form-checkbox text-amber-500 rounded bg-slate-800 border-slate-600 focus:ring-amber-500">
                                    <span>Thu</span>
                                </label>
                                <label class="flex items-center space-x-1 text-sm text-slate-300">
                                    <input type="checkbox" name="weekly-day" value="Fri" class="form-checkbox text-amber-500 rounded bg-slate-800 border-slate-600 focus:ring-amber-500">
                                    <span>Fri</span>
                                </label>
                                <label class="flex items-center space-x-1 text-sm text-slate-300">
                                    <input type="checkbox" name="weekly-day" value="Sat" class="form-checkbox text-amber-500 rounded bg-slate-800 border-slate-600 focus:ring-amber-500">
                                    <span>Sat</span>
                                </label>
                                <label class="flex items-center space-x-1 text-sm text-slate-300">
                                    <input type="checkbox" name="weekly-day" value="Sun" class="form-checkbox text-amber-500 rounded bg-slate-800 border-slate-600 focus:ring-amber-500">
                                    <span>Sun</span>
                                </label>
                            </div>
                            <div id="monthly-options" class="hidden">
                                <label for="monthly-day-select" class="block text-slate-400 mb-1">Select Day of Month</label>
                                <select id="monthly-day-select" class="w-full p-3 rounded-lg bg-slate-700 text-slate-200 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                    <!-- Days 1-31 will be populated by JS -->
                                </select>
                            </div>
                        </div>

                        <button type="submit" class="w-full bg-emerald-500 text-slate-900 font-bold p-3 rounded-lg hover:bg-emerald-600 transition-colors duration-200">Add Expense</button>
                    </form>
                </div>
                <!-- Budgeting Section -->
                <div class="bg-slate-800 p-6 rounded-lg shadow-xl border border-slate-700">
                    <h2 class="text-2xl font-bold text-amber-500 mb-4">Budgeting</h2>
                    <div id="current-budget-info" class="mb-4 text-slate-300">
                        <p>Current Budget: <span id="current-budget" class="font-semibold">Not Set</span></p>
                    </div>
                    <form id="budget-form" class="space-y-4">
                        <div>
                            <label for="budget-amount" class="block text-slate-400 mb-1">Set Monthly Budget</label>
                            <input type="number" id="budget-amount" class="w-full p-3 rounded-lg bg-slate-700 text-slate-200 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="e.g., 50000" required>
                        </div>
                        <div class="flex space-x-2">
                            <button type="submit" class="flex-grow bg-emerald-500 text-slate-900 font-bold p-3 rounded-lg hover:bg-emerald-600 transition-colors duration-200">Set Budget</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Middle Column: Chart and Tips -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Data Visualization Section -->
                <div class="bg-slate-800 p-6 rounded-lg shadow-xl border border-slate-700">
                    <h2 class="text-2xl font-bold text-amber-500 mb-4">Your Spending Breakdown</h2>
                    <div class="h-64 md:h-96">
                        <canvas id="expense-chart"></canvas>
                    </div>
                </div>

                <!-- AI Tips Section -->
                <div class="bg-slate-800 p-6 rounded-lg shadow-xl border border-slate-700">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-amber-500">Financial Insights</h2>
                        <button id="fetch-suggestions-btn" class="bg-slate-700 text-slate-300 hover:bg-slate-600 px-4 py-2 rounded-lg font-medium shadow-md transition-colors duration-200">Get Suggestions</button>
                    </div>
                    <blockquote id="dynamic-quote" class="text-slate-400 italic mb-4 border-l-4 border-amber-500 pl-4">
                        <!-- Dynamic quote will be loaded here -->
                    </blockquote>
                    <div id="ai-suggestion-area" class="text-slate-300">
                        <!-- AI suggestions will be loaded here -->
                    </div>
                </div>

                <!-- Recent Expenses Table -->
                <div class="bg-slate-800 p-6 rounded-lg shadow-xl border border-slate-700">
                    <h2 class="text-2xl font-bold text-amber-500 mb-4">Recent Expenses</h2>
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="w-full text-left table-auto">
                            <thead>
                                <tr class="bg-slate-700 text-slate-300 uppercase text-sm leading-normal">
                                    <th class="py-3 px-6 text-left">Name</th>
                                    <th class="py-3 px-6 text-left">Amount</th>
                                    <th class="py-3 px-6 text-left">Category</th>
                                    <th class="py-3 px-6 text-left">Date</th>
                                    <th class="py-3 px-6 text-left">Recurring</th>
                                    <th class="py-3 px-6 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="expense-table-body" class="text-slate-300 text-sm font-light">
                                <!-- Expenses will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>
</body>
</html>
