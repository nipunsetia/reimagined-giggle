<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinTrack Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%);
        }
        .container {
            max-width: 1100px;
        }
        .card {
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-radius: 1.5rem; /* rounded-3xl */
            padding: 2.5rem; /* p-10 */
        }
        .log-message {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.875rem;
            margin-top: 4px;
            word-wrap: break-word;
        }
        .log-info {
            background-color: #e2e8f0;
            color: #4a5568;
        }
        .log-error {
            background-color: #fee2e2;
            color: #991b1b;
            font-weight: bold;
        }
        .filter-btn.active {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.3);
        }
        .filter-btn:not(.active) {
            background-color: #e5e7eb;
            color: #4b5563;
        }
        @keyframes fade-in-down {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-down {
            animation: fade-in-down 0.3s ease-out forwards;
        }
        .slide-in-right {
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }
        .slide-in-right.open {
            transform: translateX(0);
        }
        @keyframes pop-in {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pop-in {
            animation: pop-in 0.5s ease-in-out;
        }
    </style>
</head>
<body class="flex items-start justify-center min-h-screen p-4 md:p-8">
    <div class="container mx-auto relative">
        <header class="flex justify-between items-center mb-10">
            <h1 class="text-5xl font-bold text-gray-800 tracking-tight">FinTrack Pro</h1>
            <button id="toggle-info-panel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-full shadow-md transition-all duration-300 transform hover:scale-105 flex items-center">
                <i class="fas fa-info-circle mr-2"></i>
                Info
            </button>
        </header>

        <!-- Main Application View -->
        <div id="main-app-view" class="space-y-6">
            <!-- Account Creation Prompt (visible if no account exists) -->
            <div id="no-account-view" class="text-center p-10 hidden">
                <div class="card p-10 flex flex-col items-center max-w-lg mx-auto">
                    <i class="fas fa-seedling text-8xl text-emerald-500 mb-6 animate-pop-in"></i>
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Welcome to FinTrack Pro!</h2>
                    <p class="text-gray-600 mb-6 max-w-md">
                        Your financial journey starts here. Create an account to securely track your daily transactions.
                    </p>
                    <button id="create-account-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-medium py-3 px-8 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105">
                        Create My Account
                    </button>
                    <p id="account-status" class="mt-4 text-sm text-gray-500 italic">Account loading...</p>
                </div>
            </div>

            <!-- Main Dashboard (visible after account creation) -->
            <div id="dashboard-view" class="space-y-6 hidden">
                <!-- Summary and Accounts Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Total Balance Card -->
                    <div class="card p-6 flex flex-col justify-between">
                        <div>
                            <h2 class="text-xl font-semibold text-gray-800 mb-2 flex items-center">
                                <i class="fas fa-wallet text-green-500 mr-2"></i>
                                Total Balance
                            </h2>
                            <span id="total-balance" class="text-5xl font-extrabold text-gray-900">₹0.00</span>
                        </div>
                    </div>

                    <!-- Monthly Summary Card -->
                    <div class="card p-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-chart-line text-yellow-500 mr-2"></i>
                            Monthly Summary
                        </h2>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center text-lg font-medium text-gray-700">
                                <span>Income:</span>
                                <span id="monthly-income" class="font-bold text-green-600">₹0.00</span>
                            </div>
                            <div class="flex justify-between items-center text-lg font-medium text-gray-700">
                                <span>Expenses:</span>
                                <span id="monthly-expenses" class="font-bold text-red-600">₹0.00</span>
                            </div>
                            <hr class="my-2 border-gray-200">
                            <div class="flex justify-between items-center text-xl font-bold text-gray-800">
                                <span>Net Balance:</span>
                                <span id="monthly-balance" class="text-2xl font-extrabold">₹0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Frugal Fun Facts Card -->
                    <div class="card p-6 flex flex-col justify-center">
                        <h2 class="text-xl font-semibold text-gray-800 mb-2 flex items-center">
                            <i class="fas fa-lightbulb text-purple-500 mr-2"></i>
                            Frugal Fun Facts
                        </h2>
                        <p id="fun-fact" class="text-lg text-gray-700 italic text-center transition-all duration-500 ease-in-out">
                            Click the button below for a finance joke!
                        </p>
                        <button id="generate-fun-fact-btn" class="mt-4 w-full bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105">
                            ✨ Generate Fun Fact
                        </button>
                    </div>
                </div>

                <!-- AI-Powered Financial Insights -->
                <div class="card p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                            <i class="fas fa-brain text-emerald-500 mr-2"></i>
                            Financial Insights
                        </h2>
                        <button id="generate-summary-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-medium py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105">
                            ✨ Generate Spending Summary
                        </button>
                    </div>
                    <div id="summary-content" class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <p class="text-gray-500 italic">Your personalized summary will appear here. It may take a moment to generate.</p>
                    </div>
                </div>

                <!-- Transaction Form and Accounts -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Transaction Form -->
                    <div class="card p-6 col-span-2">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-pen-to-square text-blue-500 mr-2"></i>
                            Record Transaction
                        </h2>
                        <form id="transaction-form" class="space-y-4">
                            <input type="hidden" id="transaction-id">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="date" class="block text-sm font-medium text-gray-700">Date</label>
                                    <input type="date" id="date" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                                    <input type="text" id="description" placeholder="e.g., Groceries" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="amount" class="block text-sm font-medium text-gray-700">Amount</label>
                                    <input type="number" id="amount" placeholder="e.g., 50.00" step="0.01" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="type" class="block text-sm font-medium text-gray-700">Type</label>
                                    <select id="type" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                        <option value="expense" selected>Expense</option>
                                        <option value="income">Income</option>
                                    </select>
                                </div>
                                <div class="flex items-end">
                                    <button type="submit" id="submit-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105">
                                        Add Transaction
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Account Info Card -->
                    <div class="card p-6 flex flex-col justify-between">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-folder-open text-indigo-500 mr-2"></i>
                            Your Account
                        </h2>
                        <div class="space-y-2">
                            <p class="text-gray-600">Your data is stored under a single, dedicated account.</p>
                            <p id="account-status-dashboard" class="text-gray-500 italic">Account Active</p>
                        </div>
                        <button id="delete-account-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 mt-4">
                            Delete My Account
                        </button>
                    </div>
                </div>
                
                <!-- Transaction List & Filters -->
                <div class="card p-6">
                    <div class="flex flex-col md:flex-row md:items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold text-gray-800 mb-2 md:mb-0 flex items-center">
                            <i class="fas fa-list-ul text-rose-500 mr-2"></i>
                            Transaction History
                        </h2>
                        <div class="flex flex-wrap space-x-2">
                            <button onclick="setFilter('all')" class="filter-btn flex-1 font-medium py-2 px-4 rounded-lg shadow-sm transition-colors duration-200">All</button>
                            <button onclick="setFilter('income')" class="filter-btn flex-1 font-medium py-2 px-4 rounded-lg shadow-sm transition-colors duration-200">Income</button>
                            <button onclick="setFilter('expense')" class="filter-btn flex-1 font-medium py-2 px-4 rounded-lg shadow-sm transition-colors duration-200">Expenses</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-lg">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-lg">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="transaction-list" class="bg-white divide-y divide-gray-200">
                                <!-- Transactions will be added here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Info/Log Panel (Hidden by default) -->
        <div id="info-panel" class="fixed top-0 right-0 h-full w-full md:w-1/3 bg-white shadow-2xl z-40 p-8 pt-20 overflow-y-auto slide-in-right">
            <button id="close-info-panel-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-900 transition-colors duration-200">
                <i class="fas fa-times text-2xl"></i>
            </button>
            
            <!-- User ID Card -->
            <div class="card p-6 mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-id-badge text-indigo-500 mr-2"></i>
                    Your Unique ID
                </h2>
                <div id="user-info">
                    <p class="text-sm text-gray-500">Your data is stored securely under this unique identifier:</p>
                    <p id="user-id" class="font-mono bg-gray-100 px-2 py-1 mt-2 rounded-md text-gray-700 break-all">Loading...</p>
                </div>
            </div>

            <!-- App Log Card -->
            <div class="card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                        <i class="fas fa-clipboard-list text-orange-500 mr-2"></i>
                        App Log
                    </h2>
                    <button id="clear-log-btn" class="text-sm text-red-500 hover:text-red-700 font-medium transition duration-200">Clear Log</button>
                </div>
                <div id="log-display" class="bg-gray-50 p-4 rounded-lg h-60 overflow-y-auto border border-gray-200 text-sm">
                    <p class="text-gray-500 italic">Logs will appear here...</p>
                </div>
            </div>
        </div>

        <!-- Modal for deleting an account -->
        <div id="delete-modal" class="fixed inset-0 z-50 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden flex items-center justify-center">
            <div class="relative mx-auto p-8 border w-full max-w-md shadow-2xl rounded-3xl bg-white animate-fade-in-down">
                <h3 class="text-2xl font-bold text-gray-900 mb-4 text-center">Confirm Deletion</h3>
                <p id="delete-modal-message" class="text-gray-600 mb-6 text-center">Are you sure you want to permanently delete your account and all its transactions? This action cannot be undone.</p>
                <div class="flex gap-4">
                    <button id="delete-modal-confirm-btn" class="flex-1 px-4 py-3 bg-red-600 text-white font-medium rounded-xl shadow-lg hover:bg-red-700 focus:outline-none transition-colors duration-300">Delete</button>
                    <button id="delete-modal-cancel-btn" class="flex-1 px-4 py-3 bg-gray-200 text-gray-700 font-medium rounded-xl shadow-lg hover:bg-gray-300 focus:outline-none transition-colors duration-300">Cancel</button>
                </div>
            </div>
        </div>

        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
            import { getAuth, signInWithCustomToken, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
            import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

            // IMPORTANT: The following global variables are provided by the canvas environment.
            // DO NOT change them.
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            // Initialize Firebase
            let db, auth;
            let userId = null;
            let unsubscribeTransactions = null;
            let hasAccount = false;
            const ACCOUNT_ID = 'main_account'; // Fixed ID for the single account

            const form = document.getElementById('transaction-form');
            const transactionList = document.getElementById('transaction-list');
            const totalBalanceElement = document.getElementById('total-balance');
            const submitButton = document.getElementById('submit-button');
            const monthlyIncomeElement = document.getElementById('monthly-income');
            const monthlyExpensesElement = document.getElementById('monthly-expenses');
            const monthlyBalanceElement = document.getElementById('monthly-balance');
            const userIdElement = document.getElementById('user-id');
            const logDisplay = document.getElementById('log-display');
            const clearLogBtn = document.getElementById('clear-log-btn');
            const deleteModal = document.getElementById('delete-modal');
            const deleteModalMessage = document.getElementById('delete-modal-message');
            const deleteModalConfirmBtn = document.getElementById('delete-modal-confirm-btn');
            const deleteModalCancelBtn = document.getElementById('delete-modal-cancel-btn');
            const infoPanel = document.getElementById('info-panel');
            const toggleInfoPanelBtn = document.getElementById('toggle-info-panel-btn');
            const closeInfoPanelBtn = document.getElementById('close-info-panel-btn');
            const funFactElement = document.getElementById('fun-fact');
            const createAccountBtn = document.getElementById('create-account-btn');
            const deleteAccountBtn = document.getElementById('delete-account-btn');
            const noAccountView = document.getElementById('no-account-view');
            const dashboardView = document.getElementById('dashboard-view');
            const accountStatusElement = document.getElementById('account-status');
            const accountStatusDashboardElement = document.getElementById('account-status-dashboard');
            const generateFunFactBtn = document.getElementById('generate-fun-fact-btn');
            const generateSummaryBtn = document.getElementById('generate-summary-btn');
            const summaryContent = document.getElementById('summary-content');

            let transactions = [];
            let currentCurrency = '₹';
            let currentFilter = 'all';
            let editingTransactionId = null;

            // Toggling the Info Panel
            toggleInfoPanelBtn.addEventListener('click', () => {
                infoPanel.classList.toggle('slide-in-right');
                infoPanel.classList.toggle('open');
            });

            closeInfoPanelBtn.addEventListener('click', () => {
                infoPanel.classList.remove('open');
                infoPanel.classList.add('slide-in-right');
            });

            // Function to handle logging to the UI
            function logMessage(message, type = 'info') {
                const logEntry = document.createElement('div');
                logEntry.className = `log-message ${type === 'error' ? 'log-error' : 'log-info'}`;
                logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                logDisplay.prepend(logEntry); // Prepend to show newest first
                // Remove the initial "Logs will appear here..." message if it exists
                const initialMessage = logDisplay.querySelector('p');
                if (initialMessage) {
                    initialMessage.remove();
                }
            }

            clearLogBtn.addEventListener('click', () => {
                logDisplay.innerHTML = '<p class="text-gray-500 italic">Logs will appear here...</p>';
            });

            // Modal functions for deleting an account
            if (deleteAccountBtn) {
                deleteAccountBtn.addEventListener('click', () => {
                    deleteModal.classList.remove('hidden');
                });
            }

            if (deleteModalConfirmBtn) {
                deleteModalConfirmBtn.addEventListener('click', async () => {
                    deleteModal.classList.add('hidden');
                    await deleteAccount();
                });
            }

            if (deleteModalCancelBtn) {
                deleteModalCancelBtn.addEventListener('click', () => {
                    deleteModal.classList.add('hidden');
                    logMessage("Account deletion cancelled.");
                });
            }

            // Function to render transactions and update balance
            function renderTransactions() {
                transactionList.innerHTML = ''; // Clear the current list
                let total = 0;
                let monthlyIncome = 0;
                let monthlyExpenses = 0;
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();

                // Sort transactions by date (newest first)
                const sortedTransactions = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));

                // Filter transactions based on the current filter
                const filteredTransactions = sortedTransactions.filter(t => {
                    if (currentFilter === 'all') return true;
                    return t.type === currentFilter;
                });

                if (filteredTransactions.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="5" class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500 italic">No transactions recorded yet.</td>
                    `;
                    transactionList.appendChild(row);
                } else {
                    filteredTransactions.forEach((transaction) => {
                        const row = document.createElement('tr');
                        const amountClass = transaction.type === 'income' ? 'text-green-600' : 'text-red-600';
                        const sign = transaction.type === 'income' ? '+' : '-';
                        const formattedAmount = `${currentCurrency}${Math.abs(transaction.amount).toFixed(2)}`;
                        
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${transaction.date}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${transaction.description}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm capitalize text-gray-500">${transaction.type}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-bold ${amountClass}">${sign} ${formattedAmount}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                <button onclick="editTransaction('${transaction.id}')" class="text-blue-600 hover:text-blue-800 transition-colors duration-200">Edit</button>
                                <button onclick="deleteTransaction('${transaction.id}')" class="text-red-600 hover:text-red-800 transition-colors duration-200">Delete</button>
                            </td>
                        `;
                        transactionList.appendChild(row);
                    });
                }

                // Recalculate total balance for all transactions, regardless of filter
                transactions.forEach(t => {
                    if (t.type === 'income') {
                        total += parseFloat(t.amount);
                    } else {
                        total -= parseFloat(t.amount);
                    }

                    // Calculate monthly summary
                    const transactionDate = new Date(t.date);
                    if (transactionDate.getMonth() === currentMonth && transactionDate.getFullYear() === currentYear) {
                        if (t.type === 'income') {
                            monthlyIncome += parseFloat(t.amount);
                        } else {
                            monthlyExpenses += parseFloat(t.amount);
                        }
                    }
                });

                // Update balance displays
                totalBalanceElement.textContent = `${currentCurrency}${total.toFixed(2)}`;
                if (total < 0) {
                    totalBalanceElement.classList.add('text-red-600');
                    totalBalanceElement.classList.remove('text-gray-900');
                } else {
                    totalBalanceElement.classList.remove('text-red-600');
                    totalBalanceElement.classList.add('text-gray-900');
                }

                monthlyIncomeElement.textContent = `${currentCurrency}${monthlyIncome.toFixed(2)}`;
                monthlyExpensesElement.textContent = `${currentCurrency}${monthlyExpenses.toFixed(2)}`;
                const monthlyBalance = monthlyIncome - monthlyExpenses;
                monthlyBalanceElement.textContent = `${currentCurrency}${monthlyBalance.toFixed(2)}`;
                if (monthlyBalance < 0) {
                    monthlyBalanceElement.classList.add('text-red-600');
                    monthlyBalanceElement.classList.remove('text-gray-800');
                } else {
                    monthlyBalanceElement.classList.remove('text-red-600');
                    monthlyBalanceElement.classList.add('text-gray-800');
                }
            }

            // Function to set the transaction filter
            function setFilter(filterType) {
                currentFilter = filterType;
                // Update button styles
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.textContent.toLowerCase() === filterType || (btn.textContent.toLowerCase() === 'all' && filterType === 'all')) {
                        btn.classList.add('active');
                    }
                });
                renderTransactions();
            }

            // Export setFilter globally for onclick
            window.setFilter = setFilter;

            // Handle form submission (Add/Edit)
            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    if (!hasAccount) {
                        logMessage("No account exists. Please create one.", 'error');
                        return;
                    }

                    const date = document.getElementById('date').value;
                    const description = document.getElementById('description').value;
                    const amount = parseFloat(document.getElementById('amount').value);
                    const type = document.getElementById('type').value;

                    const transactionData = {
                        date: date,
                        description: description,
                        amount: amount,
                        type: type,
                        timestamp: new Date().toISOString()
                    };

                    try {
                        if (editingTransactionId) {
                            const transactionRef = doc(db, `/artifacts/${appId}/users/${userId}/accounts/${ACCOUNT_ID}/transactions`, editingTransactionId);
                            await setDoc(transactionRef, transactionData);
                            logMessage(`Transaction '${description}' updated successfully.`);
                            editingTransactionId = null;
                            submitButton.textContent = "Add Transaction";
                        } else {
                            const transactionsCollectionRef = collection(db, `/artifacts/${appId}/users/${userId}/accounts/${ACCOUNT_ID}/transactions`);
                            await addDoc(transactionsCollectionRef, transactionData);
                            logMessage(`Transaction '${description}' added successfully.`);
                        }
                    } catch (error) {
                        logMessage(`Error adding/updating transaction: ${error.message}`, 'error');
                    }

                    form.reset();
                });
            }

            // Function to edit a transaction
            window.editTransaction = function(id) {
                const transaction = transactions.find(t => t.id === id);
                if (transaction) {
                    document.getElementById('date').value = transaction.date;
                    document.getElementById('description').value = transaction.description;
                    document.getElementById('amount').value = transaction.amount;
                    document.getElementById('type').value = transaction.type;
                    editingTransactionId = id;
                    submitButton.textContent = "Update Transaction";
                    document.getElementById('date').focus();
                    logMessage(`Editing transaction with ID: ${id}`);
                }
            }

            // Function to delete a transaction
            window.deleteTransaction = async function(id) {
                if (!hasAccount) {
                    logMessage("No account selected.", 'error');
                    return;
                }
                try {
                    const transactionRef = doc(db, `/artifacts/${appId}/users/${userId}/accounts/${ACCOUNT_ID}/transactions`, id);
                    await deleteDoc(transactionRef);
                    logMessage(`Transaction with ID ${id} deleted successfully.`);
                } catch (error) {
                    logMessage(`Error deleting transaction: ${error.message}`, 'error');
                }
            }

            async function createAccount() {
                if (!userId) {
                    logMessage("User not authenticated.", 'error');
                    return;
                }
                logMessage(`Attempting to create a new account for user ID: ${userId}`);
                const accountDocRef = doc(db, `/artifacts/${appId}/users/${userId}/accounts`, ACCOUNT_ID);
                try {
                    await setDoc(accountDocRef, { name: 'Main Account', createdAt: new Date().toISOString() });
                    logMessage(`Account 'Main Account' created successfully.`);
                } catch (error) {
                    logMessage(`Error creating account: ${error.message}`, 'error');
                }
            }

            // Function to delete an account and its transactions
            async function deleteAccount() {
                if (!hasAccount) {
                    logMessage("No account is currently selected.", 'error');
                    return;
                }
                
                logMessage(`Deleting user's account and all data...`);
                try {
                    // First, delete all transactions in the subcollection
                    const transactionsCollectionRef = collection(db, `/artifacts/${appId}/users/${userId}/accounts/${ACCOUNT_ID}/transactions`);
                    const transactionSnapshot = await getDocs(transactionsCollectionRef);

                    const deletePromises = transactionSnapshot.docs.map(tDoc => deleteDoc(tDoc.ref));
                    await Promise.all(deletePromises);
                    logMessage(`Deleted ${transactionSnapshot.docs.length} transactions.`);

                    // Then, delete the account document itself
                    const accountDocRef = doc(db, `/artifacts/${appId}/users/${userId}/accounts`, ACCOUNT_ID);
                    await deleteDoc(accountDocRef);
                    
                    hasAccount = false;
                    transactions = [];
                    renderTransactions();
                    logMessage(`Account and all user data deleted successfully.`);
                } catch (error) {
                    logMessage(`Error deleting account: ${error.message}`, 'error');
                }
            }
            
            if (createAccountBtn) {
                createAccountBtn.addEventListener('click', createAccount);
            }


            function setupTransactionListener() {
                if (unsubscribeTransactions) {
                    unsubscribeTransactions(); // Unsubscribe from the old listener
                    logMessage("Unsubscribed from previous transaction listener.");
                }

                if (hasAccount) {
                    logMessage(`Setting up transaction listener for account.`);
                    const transactionsCollectionRef = collection(db, `/artifacts/${appId}/users/${userId}/accounts/${ACCOUNT_ID}/transactions`);
                    unsubscribeTransactions = onSnapshot(transactionsCollectionRef, (snapshot) => {
                        transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        renderTransactions();
                        logMessage("Transactions updated from Firestore.");
                    }, (error) => {
                        logMessage(`Error fetching transactions: ${error.message}`, 'error');
                    });
                } else {
                    transactions = [];
                    renderTransactions();
                    logMessage("No account exists, transaction listener not active.");
                }
            }

            // Check if an account exists for the user
            async function checkAndInitializeAccount() {
                if (!userId) {
                    return;
                }
                logMessage("Checking for existing account...");
                const accountDocRef = doc(db, `/artifacts/${appId}/users/${userId}/accounts`, ACCOUNT_ID);
                onSnapshot(accountDocRef, async (docSnapshot) => {
                    if (docSnapshot.exists()) {
                        logMessage("Account found. Initializing dashboard.");
                        hasAccount = true;
                        if (noAccountView) noAccountView.classList.add('hidden');
                        if (dashboardView) dashboardView.classList.remove('hidden');
                        if (deleteAccountBtn) deleteAccountBtn.disabled = false;
                        if (accountStatusDashboardElement) accountStatusDashboardElement.textContent = "Account Active";
                        setupTransactionListener();
                    } else {
                        logMessage("No account found. Showing account creation prompt.");
                        hasAccount = false;
                        if (noAccountView) noAccountView.classList.remove('hidden');
                        if (dashboardView) dashboardView.classList.add('hidden');
                        if (deleteAccountBtn) deleteAccountBtn.disabled = true;
                        if (accountStatusElement) accountStatusElement.textContent = "No account found. Create one to get started!";
                        setupTransactionListener(); // Still need to unsubscribe from old listener
                    }
                }, (error) => {
                    logMessage(`Error checking account existence: ${error.message}`, 'error');
                });
            }

            // API Call for Gemini
            async function callGeminiApi(prompt) {
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                let retries = 0;
                const maxRetries = 5;
                const initialDelay = 1000; // 1 second

                while (retries < maxRetries) {
                    try {
                        const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                        const payload = { contents: chatHistory };
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            if (result.candidates && result.candidates.length > 0 &&
                                result.candidates[0].content && result.candidates[0].content.parts &&
                                result.candidates[0].content.parts.length > 0) {
                                return result.candidates[0].content.parts[0].text;
                            } else {
                                throw new Error('Invalid API response structure.');
                            }
                        } else if (response.status === 429) {
                            // Exponential backoff on rate limit
                            const delay = initialDelay * Math.pow(2, retries);
                            logMessage(`API rate limit exceeded. Retrying in ${delay / 1000} seconds...`, 'info');
                            await new Promise(res => setTimeout(res, delay));
                            retries++;
                        } else {
                            throw new Error(`API call failed with status: ${response.status}`);
                        }
                    } catch (error) {
                        logMessage(`An error occurred during API call: ${error.message}`, 'error');
                        throw error;
                    }
                }
                throw new Error("Maximum retries exceeded. API call failed.");
            }

            // Function to generate a spending summary using Gemini
            async function generateSpendingSummary() {
                if (transactions.length === 0) {
                    summaryContent.innerHTML = `<p class="text-gray-500 italic">Please add some transactions first to generate a summary.</p>`;
                    return;
                }
                
                generateSummaryBtn.disabled = true;
                generateSummaryBtn.innerHTML = `
                    <i class="fas fa-spinner fa-spin mr-2"></i>
                    Generating...
                `;
                summaryContent.innerHTML = `
                    <div class="flex items-center justify-center p-4 text-blue-500">
                        <i class="fas fa-spinner fa-spin text-xl mr-2"></i>
                        <span class="text-sm">Analyzing your transactions...</span>
                    </div>
                `;

                // Create a clean prompt with transaction data
                const transactionDataForPrompt = transactions.map(t => ({
                    date: t.date,
                    description: t.description,
                    amount: t.amount,
                    type: t.type
                }));
                const prompt = `Based on the following financial transactions, provide a concise spending summary. Highlight key spending categories, mention any notable trends (e.g., increased spending on food), and offer one or two simple, personalized tips. Format the response as a friendly paragraph followed by a short bulleted list for the tips. Transactions: ${JSON.stringify(transactionDataForPrompt)}`;

                try {
                    const result = await callGeminiApi(prompt);
                    summaryContent.innerHTML = `<p class="text-gray-800 whitespace-pre-wrap">${result}</p>`;
                    logMessage("Successfully generated financial summary.");
                } catch (error) {
                    summaryContent.innerHTML = `<p class="text-red-500 italic">Error generating summary. Please check the app log.</p>`;
                } finally {
                    generateSummaryBtn.disabled = false;
                    generateSummaryBtn.innerHTML = `✨ Generate Spending Summary`;
                }
            }
            
            if (generateSummaryBtn) {
                generateSummaryBtn.addEventListener('click', generateSpendingSummary);
            }

            // Function to generate a fun fact using Gemini
            async function generateNewFunFact() {
                generateFunFactBtn.disabled = true;
                generateFunFactBtn.innerHTML = `
                    <i class="fas fa-spinner fa-spin mr-2"></i>
                    Generating...
                `;
                funFactElement.textContent = "Fetching a new joke...";
                funFactElement.classList.remove('animate-pop-in');

                const prompt = "Please generate a single, short, and witty joke or a 'fun fact' related to finance, money, or budgeting. Do not include a title or introduction, just the joke or fact itself.";

                try {
                    const result = await callGeminiApi(prompt);
                    funFactElement.classList.add('animate-pop-in');
                    funFactElement.textContent = result;
                    logMessage("Successfully generated a new fun fact.");
                } catch (error) {
                    funFactElement.textContent = "Couldn't get a joke right now. Try again later!";
                } finally {
                    generateFunFactBtn.disabled = false;
                    generateFunFactBtn.innerHTML = `✨ Generate Fun Fact`;
                }
            }

            if (generateFunFactBtn) {
                generateFunFactBtn.addEventListener('click', generateNewFunFact);
            }

            // Initialize App
            async function initializeFirebaseApp() {
                if (Object.keys(firebaseConfig).length === 0) {
                     logMessage("Firebase configuration is missing. The app cannot run.", 'error');
                     return;
                }

                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    // Sign in with a persistent session token if available, otherwise sign in anonymously
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        logMessage("Signed in with a persistent session token.");
                    } else {
                        await signInAnonymously(auth);
                        logMessage("Signed in anonymously.");
                    }

                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            userIdElement.textContent = userId;
                            logMessage(`User authenticated with ID: ${userId}`);
                            checkAndInitializeAccount();
                            setFilter('all'); // Set default filter
                        } else {
                            logMessage("User signed out.");
                        }
                    });
                } catch (error) {
                    logMessage(`Firebase initialization or sign-in failed: ${error.message}`, 'error');
                }
            }

            document.addEventListener('DOMContentLoaded', initializeFirebaseApp);
        </script>
    </body>
</html>
